<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>è´­é”€è®°è´¦å·¥å…· Proï¼ˆLeanCloud äº‘ç«¯ç‰ˆï¼‰</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    .container { max-width: 1400px; margin: 0 auto; }
    .header { text-align: center; color: white; margin-bottom: 18px; }
    .header h1 { font-size: 30px; margin-bottom: 8px; text-shadow: 0 2px 4px rgba(0,0,0,0.2); }
    .header p { font-size: 13px; opacity: 0.92; }

    .auth-bar {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 10px;
      align-items: center;
      margin-bottom: 18px;
    }
    @media (max-width: 768px) { .auth-bar { grid-template-columns: 1fr; } }

    .auth-info {
      background: rgba(255,255,255,0.12);
      border: 1px solid rgba(255,255,255,0.25);
      color: white;
      border-radius: 10px;
      padding: 12px 14px;
      font-size: 13px;
      line-height: 1.5;
      white-space: pre-line;
    }
    .auth-actions { display: flex; gap: 10px; flex-wrap: wrap; }
    .auth-actions .btn { width: auto; }

    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      border-bottom: 2px solid rgba(255,255,255,0.2);
    }
    .tab-btn {
      padding: 10px 16px;
      background: rgba(255,255,255,0.1);
      color: white;
      border: none;
      border-bottom: 3px solid transparent;
      cursor: pointer;
      font-size: 14px;
      border-radius: 8px 8px 0 0;
      transition: all 0.3s;
    }
    .tab-btn.active {
      background: white;
      color: #667eea;
      border-bottom: 3px solid #667eea;
    }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    .main-content { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
    @media (max-width: 1024px) { .main-content { grid-template-columns: 1fr; } }

    .card { background: white; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.1); padding: 25px; }
    .card h2 { font-size: 18px; color: #333; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #667eea; }

    .form-group { margin-bottom: 15px; }
    label { display: block; font-size: 13px; font-weight: 600; color: #555; margin-bottom: 6px; }

    input, select, textarea {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 13px;
    }
    textarea { resize: vertical; min-height: 80px; }
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .btn {
      padding: 10px 16px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      transition: all 0.3s;
    }
    .btn:hover { background: #5568d3; }
    .btn.secondary { background: #f0f0f0; color: #333; }
    .btn.secondary:hover { background: #e0e0e0; }
    .btn.danger { background: #ff6b6b; }
    .btn.danger:hover { background: #ff5252; }

    .hidden { display: none !important; }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }
    .stat-item {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
    }
    .stat-label { font-size: 12px; opacity: 0.9; }
    .stat-value { font-size: 20px; font-weight: 700; margin-top: 5px; }

    .table-container {
      overflow-x: auto;
      background: white;
      border-radius: 8px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }
    th {
      background: #f5f5f5;
      padding: 12px;
      text-align: left;
      font-weight: 600;
      border-bottom: 2px solid #ddd;
      color: #333;
    }
    td {
      padding: 10px 12px;
      border-bottom: 1px solid #f0f0f0;
    }
    tr:hover { background: #fafafa; }

    .tags-input {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 6px;
      background: white;
    }
    .tag {
      background: #667eea;
      color: white;
      padding: 6px 10px;
      border-radius: 12px;
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .tag button {
      background: none;
      border: none;
      color: white;
      cursor: pointer;
      font-size: 14px;
      padding: 0;
    }
    .tag-input-field {
      border: none;
      outline: none;
      flex: 1;
      min-width: 100px;
      font-size: 13px;
    }

    .category-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap: 10px;
      margin-bottom: 15px;
    }
    .category-item {
      padding: 10px;
      background: #f5f5f5;
      border: 2px solid transparent;
      border-radius: 8px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
    }
    .category-item:hover { border-color: #667eea; }
    .category-item.selected {
      background: #667eea;
      color: white;
      border-color: #667eea;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    .modal.active {
      display: flex;
    }
    .modal-content {
      background: white;
      padding: 30px;
      border-radius: 12px;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    }
    .modal-header {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 20px;
      color: #333;
    }
    .modal-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 20px;
    }

    .filter-bar {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 10px;
      margin-bottom: 20px;
      padding: 15px;
      background: #f9f9f9;
      border-radius: 8px;
    }

    .alert {
      padding: 12px 15px;
      border-radius: 6px;
      margin-bottom: 15px;
      font-size: 13px;
    }
    .alert.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .alert.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    .alert.info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }

    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }
    .dashboard-card {
      background: white;
      border-radius: 8px;
      padding: 20px;
      border-left: 4px solid #667eea;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    .dashboard-title { font-size: 12px; color: #999; margin-bottom: 8px; font-weight: 600; }
    .dashboard-value { font-size: 28px; font-weight: 700; color: #333; }
    .dashboard-subtitle { font-size: 11px; color: #999; margin-top: 8px; }

    .status-badges {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 10px;
      margin: 15px 0;
    }
    .badge-item {
      background: #f5f5f5;
      padding: 12px;
      border-radius: 6px;
      text-align: center;
      border: 1px solid #eee;
    }
    .badge-label { font-size: 12px; color: #666; }
    .badge-value { font-size: 20px; font-weight: 700; color: #667eea; margin-top: 4px; }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: #f0f0f0;
      border-radius: 4px;
      margin-top: 8px;
      overflow: hidden;
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea, #764ba2);
      transition: width 0.3s;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ“Š è´­é”€è®°è´¦å·¥å…· Pro</h1>
      <p>LeanCloud äº‘ç«¯ç‰ˆ - æ”¯æŒåˆ†ç±»/æ ‡ç­¾ç®¡ç† - å¤šè®¾å¤‡åŒæ­¥</p>
    </div>

    <div class="auth-bar">
      <div class="auth-info" id="authInfo">æœªç™»å½•ï¼šè¯·å…ˆç™»å½•/æ³¨å†Œ</div>
      <div class="auth-actions">
        <button class="btn" id="authBtn" onclick="toggleAuthModal()">ç™»å½•/æ³¨å†Œ</button>
        <button class="btn secondary" id="logoutBtn" onclick="signOut()" style="display:none;">é€€å‡ºç™»å½•</button>
      </div>
    </div>

    <div id="appRoot" class="hidden">
      <!-- åŠŸèƒ½é€‰é¡¹å¡ -->
      <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('records')">ğŸ“‹ äº¤æ˜“è®°å½•</button>
        <button class="tab-btn" onclick="switchTab('categories')">ğŸ·ï¸ åˆ†ç±»ç®¡ç†</button>
        <button class="tab-btn" onclick="switchTab('tags')">ğŸ”– æ ‡ç­¾ç®¡ç†</button>
        <button class="tab-btn" onclick="switchTab('analytics')">ğŸ“ˆ æ•°æ®åˆ†æ</button>
        <button class="tab-btn" onclick="switchTab('import')">ğŸ“¥ å¯¼å…¥/å¯¼å‡º</button>
      </div>

      <!-- è®°å½•ç®¡ç†é€‰é¡¹å¡ -->
      <div id="records-tab" class="tab-content active">
        <div class="main-content">
          <!-- æ·»åŠ æ–°è®°å½• -->
          <div class="card">
            <h2>â• æ·»åŠ æ–°è®°å½•</h2>
            
            <div class="form-group">
              <label>åˆ†ç±»</label>
              <div class="category-list" id="categoryList"></div>
            </div>

            <div class="form-group">
              <label>è´­ä¹°æ—¥æœŸ</label>
              <input type="date" id="buyDate" />
            </div>

            <div class="form-group">
              <label>å¹³å°</label>
              <select id="buyPlatform">
                <option>æ·˜å®</option>
                <option>äº¬ä¸œ</option>
                <option>1688</option>
                <option>å…¶ä»–</option>
              </select>
            </div>

            <div class="form-group">
              <label>è´§å·</label>
              <input type="text" id="goodsCode" placeholder="å•†å“ç¼–ç " />
            </div>

            <div class="form-group">
              <label>å•†å“æè¿°</label>
              <input type="text" id="goodsDesc" placeholder="å¦‚ï¼šNikeè·‘é‹ çº¢è‰² 42ç " />
            </div>

            <div class="form-group">
              <label>æ ‡ç­¾ï¼ˆæŒ‰å›è½¦æ·»åŠ ï¼‰</label>
              <div class="tags-input" id="tagsInput">
                <input type="text" class="tag-input-field" id="tagInputField" placeholder="è¾“å…¥æ ‡ç­¾æŒ‰Enter" />
              </div>
            </div>

            <div class="form-group">
              <label>åº“å­˜çŠ¶æ€</label>
              <select id="status">
                <option>è¿è¾“ä¸­</option>
                <option>å·²å…¥åº“</option>
                <option>ç¼ºè´§</option>
                <option>å·²å”®å‡º</option>
              </select>
            </div>

            <div class="form-group">
              <label>ä»¶æ•°</label>
              <input type="number" id="quantity" value="1" />
            </div>

            <div class="form-group">
              <label>å•ä»¶æˆæœ¬</label>
              <input type="number" id="costPrice" step="0.01" placeholder="Â¥" />
            </div>              <div class="form-group">
              <label>ä»˜æ¬¾æ–¹å¼</label>
              <select id="paymentMethod">
                <option>è‡ªä»˜</option>
                <option>ä»–äººå«ä»˜</option>
                <option>é¢„ä»˜</option>
              </select>
            </div>

            <div class="form-group">
              <label>åŒ…è£¹ID / å¿«é€’å•å· (ç”¨äºè¿è´¹å‡æ‘Š)</label>
              <input type="text" id="parcelId" placeholder="å¦‚ï¼šSF123456 æˆ– JD-20251228-1" />
            </div>

            <div class="form-group">
              <label>è¯¥åŒ…è£¹æ€»è¿è´¹ (ä»…åœ¨æ–°å»ºåŒ…è£¹æ—¶å¡«)</label>
              <input type="number" id="parcelTotalShipping" step="0.01" placeholder="Â¥" />
            </div>

            <div class="form-group">
              <label>å‡ºå”®æ—¥æœŸ</label>
              <input type="date" id="sellDate" />
            </div>

            <div class="form-group">
              <label>å•ä»¶å”®å‡ºä»·</label>
              <input type="number" id="sellPrice" step="0.01" placeholder="Â¥" />
            </div>

            <div class="form-group">
              <label>å¤‡æ³¨</label>
              <textarea id="remark" placeholder="è®°å½•ç‰¹æ®Šä¿¡æ¯"></textarea>
            </div>

            <button class="btn" onclick="addRecord()" style="width: 100%; margin-top: 10px;">âœ… æ·»åŠ è®°å½•</button>
            <button class="btn secondary" onclick="clearForm()" style="width: 100%; margin-top: 8px;">ğŸ”„ æ¸…ç©ºè¡¨å•</button>
          </div>

          <!-- æ•°æ®ç»Ÿè®¡ -->
          <div>
            <div class="card">
              <h2>ğŸ“ˆ æ•°æ®ç»Ÿè®¡</h2>
              <div class="stats-grid" id="statsContainer"></div>
            </div>

            <div class="card" style="margin-top: 20px;">
              <h2>ğŸ’¼ èµ„é‡‘æµä»ªè¡¨æ¿</h2>
              <div class="dashboard-grid" id="dashboardContainer"></div>
              <div class="status-badges" id="statusBadgesContainer"></div>
            </div>

            <div class="card" style="margin-top: 20px;">
              <h2>ğŸ“Š å›æ¬¾ç›‘æ§</h2>
              <div class="dashboard-grid" id="paymentStatsContainer"></div>
            </div>

            <div class="card" style="margin-top: 20px;">
              <h2>ğŸ” ç­›é€‰æ¡ä»¶</h2>
              <div class="filter-bar">
                <input type="number" id="filterSerialNo" placeholder="åºå·" onkeyup="applyFilters()" />
                <input type="date" id="filterBuyDate" onchange="applyFilters()" />
                <select id="filterPlatform" onchange="applyFilters()">
                  <option value="">å…¨éƒ¨å¹³å°</option>
                  <option>æ·˜å®</option>
                  <option>äº¬ä¸œ</option>
                  <option>1688</option>
                  <option>å…¶ä»–</option>
                </select>
                <input type="text" id="filterGoodsCode" placeholder="è´§å·" onkeyup="applyFilters()" />
                <select id="filterCategory" onchange="applyFilters()">
                  <option value="">å…¨éƒ¨åˆ†ç±»</option>
                </select>
                <select id="filterStatus" onchange="applyFilters()">
                  <option value="">å…¨éƒ¨çŠ¶æ€</option>
                  <option>è¿è¾“ä¸­</option>
                  <option>å·²å…¥åº“</option>
                  <option>ç¼ºè´§</option>
                  <option>å·²å”®å‡º</option>
                </select>
                <input type="text" id="filterKeyword" placeholder="å…³é”®å­—æœç´¢" onkeyup="applyFilters()" />
                <button class="btn secondary" onclick="resetFilters()">é‡ç½®ç­›é€‰</button>
              </div>
            </div>
          </div>
        </div>

        <!-- è¡¨æ ¼ -->
        <div class="card" style="margin-top: 20px;">
          <h2>ğŸ“‹ äº¤æ˜“è®°å½•</h2>
          <div style="color: #666; margin-bottom: 15px;">å½“å‰æ˜¾ç¤ºï¼š<strong id="recordCount">0</strong> æ¡</div>
          <div class="table-container">
            <table id="recordsTable">
              <thead>
                <tr>
                  <th>åºå·</th>
                  <th>åˆ†ç±»</th>
                  <th>è´­ä¹°æ—¥æœŸ</th>
                  <th>å¹³å°</th>
                  <th>è´§å·</th>
                  <th>å•†å“</th>
                  <th>æ ‡ç­¾</th>
                  <th>çŠ¶æ€</th>
                  <th>ä»¶æ•°</th>
                  <th>å•ä»¶æˆæœ¬</th>
                  <th>æ€»æˆæœ¬</th>              <th>åŒ…è£¹ID</th>
              <th>åˆ†æ‘Šè¿è´¹</th>
              <th>å‡ºå”®æ—¥æœŸ</th>
              <th>å•ä»¶å”®ä»·</th>
                  <th>æ€»å”®ä»·</th>
                  <th>åˆ©æ¶¦</th>
                  <th>åˆ©æ¶¦ç‡</th>
                  <th>æ“ä½œ</th>
                </tr>
              </thead>
              <tbody id="tableBody">
                <tr><td colspan="19" style="text-align: center; color: #999;">æš‚æ— æ•°æ®ï¼Œæ·»åŠ ç¬¬ä¸€æ¡è®°å½•å§</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- åˆ†ç±»ç®¡ç†é€‰é¡¹å¡ -->
      <div id="categories-tab" class="tab-content">
        <div class="main-content">
          <div class="card">
            <h2>ğŸ·ï¸ åˆ†ç±»ç®¡ç†</h2>
            <div class="form-group">
              <label>æ–°åˆ†ç±»åç§°</label>
              <input type="text" id="newCategoryInput" placeholder="è¾“å…¥åˆ†ç±»åç§°" />
            </div>
            <button class="btn" onclick="addCategory()" style="width: 100%;">æ·»åŠ åˆ†ç±»</button>
            <hr style="margin: 20px 0; border: none; border-top: 1px solid #ddd;">
            <div id="categoriesList"></div>
          </div>

          <div class="card">
            <h2>ğŸ“Š åˆ†ç±»ç»Ÿè®¡</h2>
            <div id="categoryStats"></div>
          </div>
        </div>
      </div>

      <!-- æ ‡ç­¾ç®¡ç†é€‰é¡¹å¡ -->
      <div id="tags-tab" class="tab-content">
        <div class="main-content">
          <div class="card">
            <h2>ğŸ”– æ ‡ç­¾ç®¡ç†</h2>
            <div id="tagsList"></div>
          </div>

          <div class="card">
            <h2>â˜ï¸ æ ‡ç­¾äº‘</h2>
            <div id="tagCloud" style="display: flex; flex-wrap: wrap; gap: 10px;"></div>
          </div>
        </div>
      </div>

      <!-- æ•°æ®åˆ†æé€‰é¡¹å¡ -->
      <div id="analytics-tab" class="tab-content">
        <div class="card">
          <h2>ğŸ“ˆ åˆ†ç±»åˆ†æ</h2>
          <div id="categoryAnalytics"></div>
        </div>
        <div class="card" style="margin-top: 20px;">
          <h2>ğŸ“Š åˆ†ç±»åˆ©æ¶¦å¯¹æ¯”</h2>
          <canvas id="categoryProfitChart" style="max-width: 100%; height: 300px; margin-top: 20px;"></canvas>
          <div id="categoryProfitTable" style="margin-top: 20px;"></div>
        </div>
        <div class="card" style="margin-top: 20px;">
          <h2>ğŸ”– æ ‡ç­¾åˆ†æ</h2>
          <div id="tagAnalytics"></div>
        </div>
        <div class="card" style="margin-top: 20px;">
          <h2>ğŸ“Š æ ‡ç­¾é”€å”®ç»Ÿè®¡</h2>
          <canvas id="tagSalesChart" style="max-width: 100%; height: 300px; margin-top: 20px;"></canvas>
          <div id="tagSalesTable" style="margin-top: 20px;"></div>
        </div>
      </div>

      <!-- å¯¼å…¥/å¯¼å‡ºé€‰é¡¹å¡ -->
      <div id="import-tab" class="tab-content">
        <div class="main-content">
          <div class="card">
            <h2>ğŸ“¥ å¯¼å…¥æ•°æ®</h2>
            <div class="form-group">
              <label>ä¸Šä¼ æ–‡ä»¶ï¼ˆTSV æˆ– CSVï¼‰</label>
              <input type="file" id="importFile" accept=".csv,.tsv,.txt" />
            </div>
            <button class="btn" onclick="importFile()" style="width: 100%;">å¯¼å…¥</button>
            <div id="importMessage" class="alert" style="display: none; margin-top: 15px;"></div>
          </div>

          <div class="card">
            <h2>ğŸ“¤ å¯¼å‡ºæ•°æ®</h2>
            <button class="btn" onclick="exportToCSV()" style="width: 100%; margin-bottom: 10px;">å¯¼å‡ºä¸º CSV</button>
            <button class="btn secondary" onclick="exportToJSON()" style="width: 100%;">å¯¼å‡ºä¸º JSON</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ç™»å½•/æ³¨å†Œæ¨¡æ€æ¡† -->
  <div class="modal" id="authModal">
    <div class="modal-content">
      <div class="modal-header">ç™»å½•/æ³¨å†Œ</div>
      <div class="form-group">
        <label>é‚®ç®±</label>
        <input type="email" id="authEmail" placeholder="user@example.com" />
      </div>
      <div class="form-group">
        <label>å¯†ç </label>
        <input type="password" id="authPassword" placeholder="è‡³å°‘6ä¸ªå­—ç¬¦" />
      </div>
      <div class="modal-actions">
        <button class="btn secondary" onclick="toggleAuthModal()">å–æ¶ˆ</button>
        <button class="btn" onclick="signUp()">æ³¨å†Œ</button>
        <button class="btn" onclick="logIn()">ç™»å½•</button>
      </div>
    </div>
  </div>

  <script>
    // LeanCloud åˆå§‹åŒ–
    const APP_ID = 'leancloud-app-id';
    const APP_KEY = 'leancloud-app-key';
    
    // å¦‚æœä½¿ç”¨çœŸå® LeanCloudï¼Œéœ€è¦æ›¿æ¢ä¸Šé¢çš„ ID å’Œ KEY
    // æœ¬æ¼”ç¤ºç‰ˆä½¿ç”¨æœ¬åœ°å­˜å‚¨æ¨¡æ‹Ÿ

    let currentUser = null;
    let records = [];
    let filteredRecords = [];
    let categories = ['æ—¥å¸¸ç”¨å“', 'å®¶ç”µ', 'æœè£…', 'å…¶ä»–'];
    let tags = [];
    let selectedCategory = 'å…¶ä»–';
    let selectedTags = [];

    // ========== æ•°æ®å…¼å®¹æ€§ ==========
    function ensureDataCompatibility(record) {
      if (!record.category) record.category = 'å…¶ä»–';
      if (!record.tags) record.tags = [];
      if (!record.created_at) record.created_at = new Date().toISOString();
      if (record.shipping_fee == null) record.shipping_fee = 0;
      if (!record.parcel_id) record.parcel_id = '';
      if (record.shipping_alloc == null) record.shipping_alloc = null;
      return record;
    }

    // ========== åŒ…è£¹è¿è´¹ç®¡ç† ==========
    function loadParcelFees() {
      const saved = localStorage.getItem('parcelFees_' + (currentUser?.id || 'guest'));
      return saved ? JSON.parse(saved) : {};
    }

    function saveParcelFees(parcelFees) {
      localStorage.setItem('parcelFees_' + (currentUser?.id || 'guest'), JSON.stringify(parcelFees));
    }

    function computeShippingAllocations(allRecords) {
      const parcelFees = loadParcelFees();
      const groups = {};

      // æŒ‰ parcel_id åˆ†ç»„
      allRecords.forEach(r => {
        const pid = (r.parcel_id || '').trim();
        if (pid) {
          if (!groups[pid]) groups[pid] = [];
          groups[pid].push(r);
        }
      });

      // è®¡ç®—å‡æ‘Šï¼ˆæŒ‰ä»¶æ•°ï¼‰
      Object.keys(groups).forEach(pid => {
        const fee = Number(parcelFees[pid] || 0);
        const list = groups[pid];
        const sumQty = list.reduce((acc, r) => acc + (Number(r.quantity) || 0), 0);
        
        list.forEach(r => {
          const q = Number(r.quantity) || 0;
          r.shipping_alloc = (sumQty > 0) ? (fee * (q / sumQty)) : 0;
        });
      });

      // æ²¡æœ‰ parcel_id çš„è®°å½•ï¼šæ²¿ç”¨æ—§çš„ shipping_fee
      allRecords.forEach(r => {
        const pid = (r.parcel_id || '').trim();
        if (!pid) r.shipping_alloc = Number(r.shipping_fee || 0);
      });

      return allRecords;
    }

    function calcMoneyStats(rows) {
      const stats = {
        statusQty: {},
        paidQty: 0,
        unpaidQty: 0,
        invest: 0,
        returned: 0,
        occupied: 0,
        realizedProfit: 0,
        unrealizedProfit: 0
      };

      rows.forEach(r => {
        const q = Number(r.quantity) || 0;
        const cost = Number(r.cost_price) || 0;
        const ship = Number(r.shipping_alloc ?? r.shipping_fee ?? 0) || 0;
        const sell = (r.sell_price == null) ? null : Number(r.sell_price);

        // çŠ¶æ€ä»¶æ•°
        stats.statusQty[r.status] = (stats.statusQty[r.status] || 0) + q;

        const buyTotal = q * cost + ship;
        stats.invest += buyTotal;

        const isPaid = (r.status === 'å·²æ‰“æ¬¾');
        if (isPaid) {
          stats.paidQty += q;
          const sellTotal = (sell == null) ? 0 : q * sell;
          stats.returned += sellTotal;
          stats.realizedProfit += (sellTotal - buyTotal);
        } else {
          stats.unpaidQty += q;
          stats.occupied += buyTotal;
          if (sell != null) {
            const sellTotal = q * sell;
            stats.unrealizedProfit += (sellTotal - buyTotal);
          }
        }
      });

      return stats;
    }

    // ========== è®¤è¯ ==========
    function toggleAuthModal() {
      document.getElementById('authModal').classList.toggle('active');
    }

    async function signUp() {
      const email = document.getElementById('authEmail').value.trim();
      const password = document.getElementById('authPassword').value;
      if (!email || !password) return alert('è¯·è¾“å…¥é‚®ç®±å’Œå¯†ç ');
      
      // æœ¬åœ°å­˜å‚¨æ¨¡æ‹Ÿ
      currentUser = { id: 'user-' + Date.now(), username: email.split('@')[0] };
      localStorage.setItem('currentUser', JSON.stringify(currentUser));
      document.getElementById('authModal').classList.remove('active');
      setLoggedInUI(currentUser);
      refreshRecords(false);
    }

    async function logIn() {
      const email = document.getElementById('authEmail').value.trim();
      if (!email) return alert('è¯·è¾“å…¥é‚®ç®±');
      
      currentUser = { id: 'user-demo', username: email.split('@')[0] };
      localStorage.setItem('currentUser', JSON.stringify(currentUser));
      document.getElementById('authModal').classList.remove('active');
      setLoggedInUI(currentUser);
      refreshRecords(false);
    }

    function setLoggedInUI(user) {
      const info = document.getElementById('authInfo');
      const root = document.getElementById('appRoot');
      if (user) {
        info.textContent = `å·²ç™»å½•ï¼š${user.username}\nï¼ˆæ•°æ®åœ¨äº‘ç«¯ï¼Œæ¢è®¾å¤‡ç™»å½•åŒè´¦å·å³å¯åŒæ­¥ï¼‰`;
        root.classList.remove('hidden');
        resetFilters();
        loadCategories();
      } else {
        info.textContent = 'æœªç™»å½•ï¼šè¯·å…ˆç™»å½•/æ³¨å†Œ';
        root.classList.add('hidden');
      }
      document.getElementById('authBtn').style.display = user ? 'none' : 'block';
      document.getElementById('logoutBtn').style.display = user ? 'block' : 'none';
    }

    function signOut() {
      currentUser = null;
      records = [];
      filteredRecords = [];
      localStorage.removeItem('currentUser');
      renderTable();
      setLoggedInUI(null);
    }

    // ========== åˆ†ç±»ç®¡ç† ==========
    function loadCategories() {
      const saved = localStorage.getItem('categories');
      if (saved) categories = JSON.parse(saved);
      renderCategorySelector();
      renderCategoriesList();
    }

    function renderCategorySelector() {
      const container = document.getElementById('categoryList');
      container.innerHTML = categories.map(cat => `
        <div class="category-item ${cat === selectedCategory ? 'selected' : ''}" 
             onclick="selectCategory('${cat}')">${cat}</div>
      `).join('');
    }

    function selectCategory(cat) {
      selectedCategory = cat;
      renderCategorySelector();
    }

    function addCategory() {
      const input = document.getElementById('newCategoryInput');
      const name = input.value.trim();
      if (!name) return alert('è¯·è¾“å…¥åˆ†ç±»åç§°');
      if (categories.includes(name)) return alert('åˆ†ç±»å·²å­˜åœ¨');
      
      categories.push(name);
      localStorage.setItem('categories', JSON.stringify(categories));
      input.value = '';
      renderCategorySelector();
      renderCategoriesList();
      updateFilterCategory();
    }

    function removeCategory(cat) {
      if (!confirm(`ç¡®å®šåˆ é™¤åˆ†ç±»"${cat}"ï¼Ÿ`)) return;
      categories = categories.filter(c => c !== cat);
      localStorage.setItem('categories', JSON.stringify(categories));
      renderCategorySelector();
      renderCategoriesList();
      updateFilterCategory();
    }

    function renderCategoriesList() {
      const container = document.getElementById('categoriesList');
      container.innerHTML = `<h3 style="margin-bottom: 15px; font-size: 14px;">å·²æœ‰åˆ†ç±» (${categories.length})</h3>` + 
        categories.map(cat => `
          <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #f5f5f5; border-radius: 6px; margin-bottom: 8px;">
            <span>${cat}</span>
            <button class="btn secondary" onclick="removeCategory('${cat}')" style="padding: 6px 12px; font-size: 12px;">åˆ é™¤</button>
          </div>
        `).join('');
    }

    function updateFilterCategory() {
      const select = document.getElementById('filterCategory');
      select.innerHTML = '<option value="">å…¨éƒ¨åˆ†ç±»</option>' + 
        categories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
    }

    // ========== æ ‡ç­¾ç®¡ç† ==========
    function addTag(tag) {
      if (!tag || selectedTags.includes(tag)) return;
      selectedTags.push(tag);
      if (!tags.includes(tag)) {
        tags.push(tag);
        localStorage.setItem('tags', JSON.stringify(tags));
      }
      renderTagsInput();
    }

    function removeTag(tag) {
      selectedTags = selectedTags.filter(t => t !== tag);
      renderTagsInput();
    }

    function renderTagsInput() {
      const container = document.getElementById('tagsInput');
      container.innerHTML = selectedTags.map(tag => `
        <div class="tag">${tag}<button onclick="removeTag('${tag}')">Ã—</button></div>
      `).join('') + `<input type="text" class="tag-input-field" id="tagInputField" placeholder="è¾“å…¥æ ‡ç­¾æŒ‰Enter" onkeypress="handleTagInput(event)" />`;
    }

    function handleTagInput(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        const input = document.getElementById('tagInputField');
        const tag = input.value.trim();
        if (tag) addTag(tag);
        input.value = '';
      }
    }

    // ========== è®°å½•ç®¡ç† ==========
    function addRecord() {
      const parcelId = document.getElementById('parcelId').value.trim();
      const parcelTotalShipping = document.getElementById('parcelTotalShipping').value;
      
      // å¦‚æœæŒ‡å®šäº†åŒ…è£¹IDå’Œè¿è´¹ï¼Œä¿å­˜åŒ…è£¹è¿è´¹æ˜ å°„
      if (parcelId && parcelTotalShipping) {
        const parcelFees = loadParcelFees();
        parcelFees[parcelId] = Number(parcelTotalShipping) || 0;
        saveParcelFees(parcelFees);
      }

      const record = {
        id: 'record-' + Date.now(),
        category: selectedCategory,
        buy_date: document.getElementById('buyDate').value,
        buy_platform: document.getElementById('buyPlatform').value,
        goods_code: document.getElementById('goodsCode').value,
        goods_desc: document.getElementById('goodsDesc').value,
        tags: [...selectedTags],
        status: document.getElementById('status').value,
        quantity: Number(document.getElementById('quantity').value),
        cost_price: Number(document.getElementById('costPrice').value) || 0,
        parcel_id: parcelId,
        payment_method: document.getElementById('paymentMethod').value,
        sell_date: document.getElementById('sellDate').value || null,
        sell_price: document.getElementById('sellPrice').value ? Number(document.getElementById('sellPrice').value) : null,
        remark: document.getElementById('remark').value,
        created_at: new Date().toISOString()
      };

      records.push(ensureDataCompatibility(record));
      localStorage.setItem('records_' + currentUser.id, JSON.stringify(records));
      clearForm();
      applyFilters();
      alert('âœ… è®°å½•æ·»åŠ æˆåŠŸ');
    }

    function clearForm() {
      document.getElementById('buyDate').value = '';
      document.getElementById('goodsCode').value = '';
      document.getElementById('goodsDesc').value = '';
      document.getElementById('quantity').value = 1;
      document.getElementById('costPrice').value = '';
      document.getElementById('parcelId').value = '';
      document.getElementById('parcelTotalShipping').value = '';
      document.getElementById('sellDate').value = '';
      document.getElementById('sellPrice').value = '';
      document.getElementById('remark').value = '';
      selectedTags = [];
      selectedCategory = 'å…¶ä»–';
      renderTagsInput();
      renderCategorySelector();
    }

    function deleteRecord(id) {
      if (!confirm('ç¡®å®šåˆ é™¤æ­¤è®°å½•ï¼Ÿ')) return;
      records = records.filter(r => r.id !== id);
      localStorage.setItem('records_' + currentUser.id, JSON.stringify(records));
      applyFilters();
    }

    function editRecord(id) {
      const record = records.find(r => r.id === id);
      if (!record) return;
      
      document.getElementById('buyDate').value = record.buy_date;
      document.getElementById('buyPlatform').value = record.buy_platform;
      document.getElementById('goodsCode').value = record.goods_code;
      document.getElementById('goodsDesc').value = record.goods_desc;
      document.getElementById('quantity').value = record.quantity;
      document.getElementById('costPrice').value = record.cost_price;
      document.getElementById('parcelId').value = record.parcel_id || '';
      const parcelFees = loadParcelFees();
      const pid = (record.parcel_id || '').trim();
      document.getElementById('parcelTotalShipping').value = (pid && parcelFees[pid]) ? parcelFees[pid] : '';
      document.getElementById('status').value = record.status;
      document.getElementById('paymentMethod').value = record.payment_method;
      document.getElementById('sellDate').value = record.sell_date || '';
      document.getElementById('sellPrice').value = record.sell_price ?? '';
      document.getElementById('remark').value = record.remark;
      selectedCategory = record.category || 'å…¶ä»–';
      selectedTags = [...(record.tags || [])];
      
      renderCategorySelector();
      renderTagsInput();
      
      deleteRecord(id);
      window.scrollTo(0, 0);
    }

    // ========== ç­›é€‰å’Œæ¸²æŸ“ ==========
    function applyFilters() {
      const category = document.getElementById('filterCategory').value;
      const status = document.getElementById('filterStatus').value;
      const platform = document.getElementById('filterPlatform').value;
      const keyword = document.getElementById('filterKeyword').value.toLowerCase();
      const serialNoFilter = document.getElementById('filterSerialNo').value.trim();
      const buyDateFilter = document.getElementById('filterBuyDate').value;
      const goodsCodeFilter = document.getElementById('filterGoodsCode').value.toLowerCase().trim();

      filteredRecords = records.filter((r, index) => {
        if (category && r.category !== category) return false;
        if (status && r.status !== status) return false;
        if (platform && r.buy_platform !== platform) return false;
        if (serialNoFilter && (index + 1) !== Number(serialNoFilter)) return false;
        if (buyDateFilter && r.buy_date !== buyDateFilter) return false;
        if (goodsCodeFilter && !r.goods_code.toLowerCase().includes(goodsCodeFilter)) return false;
        if (keyword) {
          const searchText = (r.goods_code + r.goods_desc + (r.tags || []).join(' ')).toLowerCase();
          if (!searchText.includes(keyword)) return false;
        }
        return true;
      });

      renderTable();
      updateStats();
    }

    function resetFilters() {
      document.getElementById('filterSerialNo').value = '';
      document.getElementById('filterBuyDate').value = '';
      document.getElementById('filterPlatform').value = '';
      document.getElementById('filterGoodsCode').value = '';
      document.getElementById('filterCategory').value = '';
      document.getElementById('filterStatus').value = '';
      document.getElementById('filterKeyword').value = '';
      applyFilters();
    }

    function renderTable() {
      const tbody = document.getElementById('tableBody');
      if (filteredRecords.length === 0) {
        tbody.innerHTML = '<tr><td colspan="16" style="text-align: center; color: #999;">æš‚æ— æ•°æ®ï¼Œæ·»åŠ ç¬¬ä¸€æ¡è®°å½•å§</td></tr>';
        document.getElementById('recordCount').textContent = '0';
        return;
      }

      tbody.innerHTML = filteredRecords.map((r, i) => {
        const totalCost = r.quantity * r.cost_price;
        const shippingAlloc = r.shipping_alloc ?? r.shipping_fee ?? 0;
        const totalSell = r.sell_price !== null ? r.quantity * r.sell_price : null;
        // åˆ©æ¶¦ = å”®å‡ºä»·æ ¼ - æˆæœ¬ - åˆ†æ‘Šè¿è´¹
        const profit = totalSell !== null ? (totalSell - totalCost - shippingAlloc).toFixed(2) : '-';
        const profitRate = totalSell !== null && (totalCost + shippingAlloc) > 0 ? (((totalSell - totalCost - shippingAlloc) / (totalCost + shippingAlloc)) * 100).toFixed(1) : '-';

        return `
          <tr>
            <td>${i + 1}</td>
            <td>${r.category || '-'}</td>
            <td>${r.buy_date || '-'}</td>
            <td>${r.buy_platform}</td>
            <td>${r.goods_code || '-'}</td>
            <td>${r.goods_desc || '-'}</td>
            <td>${(r.tags || []).map(t => `<span style="background: #667eea; color: white; padding: 2px 6px; border-radius: 4px; font-size: 11px; margin-right: 4px; display: inline-block;">${t}</span>`).join('')}</td>
            <td>${r.status}</td>
            <td>${r.quantity}</td>
            <td>Â¥${r.cost_price.toFixed(2)}</td>
            <td>Â¥${totalCost.toFixed(2)}</td>
            <td>${r.parcel_id ? r.parcel_id : '-'}</td>
            <td>Â¥${shippingAlloc.toFixed(2)}</td>
            <td>${r.sell_date || '-'}</td>
            <td>${r.sell_price !== null ? 'Â¥' + r.sell_price.toFixed(2) : '-'}</td>
            <td>${totalSell !== null ? 'Â¥' + totalSell.toFixed(2) : '-'}</td>
            <td style="color: ${profit > 0 ? 'green' : 'red'}">${profit !== '-' ? 'Â¥' + profit : '-'}</td>
            <td>${profitRate}%</td>
            <td style="font-size: 12px;">
              <button class="btn secondary" onclick="editRecord('${r.id}')" style="padding: 4px 8px; margin-bottom: 4px;">ç¼–è¾‘</button>
              <button class="btn danger" onclick="deleteRecord('${r.id}')" style="padding: 4px 8px;">åˆ é™¤</button>
            </td>
          </tr>
        `;
      }).join('');

      document.getElementById('recordCount').textContent = filteredRecords.length;
    }

    function updateStats() {
      // å…ˆè®¡ç®—åˆ†æ‘Šè¿è´¹
      computeShippingAllocations(filteredRecords);
      
      // èšåˆç»Ÿè®¡
      const stats = calcMoneyStats(filteredRecords);

      // ä»ªè¡¨æ¿ï¼šèµ„é‡‘æµç›‘æ§
      const dashboardContainer = document.getElementById('dashboardContainer');
      dashboardContainer.innerHTML = `
        <div class="dashboard-card">
          <div class="dashboard-title">ğŸ’° ç´¯è®¡æŠ•å…¥</div>
          <div class="dashboard-value">Â¥${stats.invest.toFixed(2)}</div>
          <div class="dashboard-subtitle">æˆæœ¬+åˆ†æ‘Šè¿è´¹</div>
        </div>
        <div class="dashboard-card">
          <div class="dashboard-title">âœ… å·²å›æ¬¾é‡‘é¢</div>
          <div class="dashboard-value" style="color: #51cf66;">Â¥${stats.returned.toFixed(2)}</div>
          <div class="dashboard-subtitle">å·²æ‰“æ¬¾è®¢å•æ”¶å…¥</div>
        </div>
        <div class="dashboard-card">
          <div class="dashboard-title">â³ å ç”¨èµ„é‡‘</div>
          <div class="dashboard-value" style="color: #ff6b6b;">Â¥${stats.occupied.toFixed(2)}</div>
          <div class="dashboard-subtitle">æœªå›æ¬¾è®¢å•æŠ•å…¥</div>
        </div>
        <div class="dashboard-card">
          <div class="dashboard-title">ğŸ“ˆ å·²å®ç°åˆ©æ¶¦</div>
          <div class="dashboard-value" style="color: ${stats.realizedProfit >= 0 ? '#51cf66' : '#ff6b6b'};">Â¥${stats.realizedProfit.toFixed(2)}</div>
          <div class="dashboard-subtitle">å·²æ‰“æ¬¾çš„åˆ©æ¶¦</div>
        </div>
      `;

      // è´§å“çŠ¶æ€åˆ†å¸ƒ
      const statusBadgesContainer = document.getElementById('statusBadgesContainer');
      const statusOptions = ['è¿è¾“ä¸­', 'å·²å…¥åº“', 'ç¼ºè´§', 'å·²å”®å‡º', 'å·²æ‰“æ¬¾'];
      statusBadgesContainer.innerHTML = statusOptions.map(status => {
        const qty = stats.statusQty[status] || 0;
        return `
          <div class="badge-item">
            <div class="badge-label">${status}</div>
            <div class="badge-value">${qty}</div>
          </div>
        `;
      }).join('');

      // å›æ¬¾ç›‘æ§
      const paymentStatsContainer = document.getElementById('paymentStatsContainer');
      const paymentRate = stats.invest > 0 ? ((stats.returned / stats.invest) * 100).toFixed(1) : 0;
      paymentStatsContainer.innerHTML = `
        <div class="dashboard-card">
          <div class="dashboard-title">ğŸ“¦ å·²å›æ¬¾ä»¶æ•°</div>
          <div class="dashboard-value">${stats.paidQty}</div>
          <div class="dashboard-subtitle">å·²æ‰“æ¬¾è®¢å•</div>
        </div>
        <div class="dashboard-card">
          <div class="dashboard-title">ğŸ“¦ æœªå›æ¬¾ä»¶æ•°</div>
          <div class="dashboard-value" style="color: #ff9800;">${stats.unpaidQty}</div>
          <div class="dashboard-subtitle">å¾…å›æ¬¾è®¢å•</div>
        </div>
        <div class="dashboard-card">
          <div class="dashboard-title">ğŸ’¹ å›æ¬¾ç‡</div>
          <div class="dashboard-value" style="color: #667eea;">${paymentRate}%</div>
          <div class="progress-bar"><div class="progress-fill" style="width: ${paymentRate}%"></div></div>
        </div>
      `;

      // å…³é”®æŒ‡æ ‡
      const container = document.getElementById('statsContainer');
      const totalRecords = filteredRecords.length;
      const roi = stats.returned > 0 ? ((stats.realizedProfit / stats.returned) * 100).toFixed(1) : 0;

      container.innerHTML = `
        <div class="stat-item">
          <div class="stat-label">æ˜¾ç¤ºè®°å½•æ•°</div>
          <div class="stat-value">${totalRecords}</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">å¹³å‡æˆæœ¬/ä»¶</div>
          <div class="stat-value">Â¥${(totalRecords > 0 ? stats.invest / (stats.paidQty + stats.unpaidQty) : 0).toFixed(2)}</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">ROI (å·²å®ç°)</div>
          <div class="stat-value" style="color: ${roi >= 0 ? '#51cf66' : '#ff6b6b'};">${roi}%</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">èµ„é‡‘æµå‘</div>
          <div class="stat-value">æŠ•å…¥/å›æ¬¾</div>
          <div style="font-size: 12px; margin-top: 8px; color: #999;">Â¥${stats.invest.toFixed(2)}/Â¥${stats.returned.toFixed(2)}</div>
        </div>
      `;
    }

    // ========== å¯¼å…¥å¯¼å‡º ==========
    async function importFile() {
      const file = document.getElementById('importFile').files[0];
      if (!file) return alert('è¯·é€‰æ‹©æ–‡ä»¶');

      const text = await file.text();
      const lines = text.split('\n').map(l => l.trim()).filter(l => l);
      if (lines.length < 2) return alert('æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®');

      const headerLine = lines[0];
      const isTab = headerLine.includes('\t');
      const delimiter = isTab ? '\t' : ',';

      try {
        const headers = headerLine.split(delimiter).map(h => h.trim());
        const importedRecords = [];

        for (let i = 1; i < lines.length; i++) {
          const values = lines[i].split(delimiter).map(v => v.trim());
          if (values.length < 3) continue;

          const record = {
            id: 'record-' + Date.now() + i,
            category: 'å…¶ä»–',
            buy_date: values[headers.indexOf('è´­ä¹°æ—¥æœŸ')] || '',
            buy_platform: values[headers.indexOf('å¹³å°')] || 'æ·˜å®',
            goods_code: values[headers.indexOf('è´§å·')] || '',
            goods_desc: values[headers.indexOf('å•†å“æè¿°')] || '',
            tags: [],
            status: values[headers.indexOf('åº“å­˜çŠ¶æ€')] || 'è¿è¾“ä¸­',
            quantity: Number(values[headers.indexOf('ä»¶æ•°')]) || 1,
            cost_price: Number(values[headers.indexOf('å•ä»¶æˆæœ¬')]) || 0,
            payment_method: 'è‡ªä»˜',
            sell_date: values[headers.indexOf('å‡ºå”®æ—¥æœŸ')] || '',
            sell_price: values[headers.indexOf('å•ä»¶å”®ä»·')] ? Number(values[headers.indexOf('å•ä»¶å”®ä»·')]) : null,
            remark: values[headers.indexOf('å¤‡æ³¨')] || '',
            created_at: new Date().toISOString()
          };

          importedRecords.push(ensureDataCompatibility(record));
        }

        records.push(...importedRecords);
        localStorage.setItem('records_' + currentUser.id, JSON.stringify(records));
        
        const msg = document.getElementById('importMessage');
        msg.textContent = `âœ… æˆåŠŸå¯¼å…¥ ${importedRecords.length} æ¡è®°å½•`;
        msg.className = 'alert success';
        msg.style.display = 'block';

        setTimeout(() => {
          applyFilters();
          document.getElementById('importFile').value = '';
        }, 1500);
      } catch (err) {
        const msg = document.getElementById('importMessage');
        msg.textContent = `âŒ å¯¼å…¥å¤±è´¥ï¼š${err.message}`;
        msg.className = 'alert error';
        msg.style.display = 'block';
      }
    }

    function exportToCSV() {
      if (records.length === 0) return alert('æ²¡æœ‰æ•°æ®å¯å¯¼å‡º');

      // å…ˆè®¡ç®—æ‰€æœ‰è¿è´¹åˆ†æ‘Š
      computeShippingAllocations(records);

      const headers = ['è´­ä¹°æ—¥æœŸ', 'å¹³å°', 'è´§å·', 'å•†å“æè¿°', 'åˆ†ç±»', 'æ ‡ç­¾', 'åº“å­˜çŠ¶æ€', 'ä»¶æ•°', 'å•ä»¶æˆæœ¬', 'æ€»æˆæœ¬', 'åŒ…è£¹ID', 'åˆ†æ‘Šè¿è´¹', 'å‡ºå”®æ—¥æœŸ', 'å•ä»¶å”®ä»·', 'æ€»å”®ä»·', 'åˆ©æ¶¦', 'å¤‡æ³¨'];
      const rows = records.map(r => {
        const totalCost = r.quantity * r.cost_price;
        const shippingAlloc = r.shipping_alloc ?? r.shipping_fee ?? 0;
        const totalSell = r.sell_price !== null ? r.quantity * r.sell_price : '';
        const profit = totalSell ? (totalSell - totalCost - shippingAlloc).toFixed(2) : '';
        return [r.buy_date, r.buy_platform, r.goods_code, r.goods_desc, r.category, (r.tags || []).join(';'), r.status, r.quantity, r.cost_price, totalCost, r.parcel_id || '', shippingAlloc.toFixed(2), r.sell_date, r.sell_price ?? '', totalSell, profit, r.remark];
      });

      const csv = [headers, ...rows].map(row => row.map(v => `"${v}"`).join(',')).join('\n');
      download('è´­é”€è®°è´¦_' + new Date().toLocaleDateString() + '.csv', csv);
    }

    function exportToJSON() {
      if (records.length === 0) return alert('æ²¡æœ‰æ•°æ®å¯å¯¼å‡º');
      const json = JSON.stringify(records, null, 2);
      download('è´­é”€è®°è´¦_' + new Date().toLocaleDateString() + '.json', json);
    }

    function download(filename, content) {
      const link = document.createElement('a');
      link.href = 'data:text/plain;charset=utf-8,' + encodeURIComponent(content);
      link.download = filename;
      link.click();
    }

    // ========== æ ‡ç­¾äº‘å’Œåˆ†æ ==========
    function renderTagCloud() {
      const container = document.getElementById('tagCloud');
      const tagCounts = {};
      records.forEach(r => {
        (r.tags || []).forEach(tag => {
          tagCounts[tag] = (tagCounts[tag] || 0) + 1;
        });
      });

      const sorted = Object.entries(tagCounts).sort((a, b) => b[1] - a[1]).slice(0, 20);
      const maxCount = sorted[0]?.[1] || 1;

      container.innerHTML = sorted.map(([tag, count]) => {
        const size = 12 + (count / maxCount) * 20;
        return `<div style="font-size: ${size}px; cursor: pointer; padding: 5px 10px; background: #f0f0f0; border-radius: 4px;" onclick="filterByTag('${tag}')">${tag} (${count})</div>`;
      }).join('');
    }

    function filterByTag(tag) {
      switchTab('records');
      // æŒ‰æ ‡ç­¾ç­›é€‰é€»è¾‘
    }

    // ========== é€‰é¡¹å¡åˆ‡æ¢ ==========
    function switchTab(tab) {
      document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
      document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
      document.getElementById(tab + '-tab').classList.add('active');
      event.target.classList.add('active');
      
      if (tab === 'tags') renderTagCloud();
      if (tab === 'analytics') {
        renderCategoryAnalytics();
        renderCategoryProfitChart();
        renderTagSalesChart();
        renderTagSalesTable();
      }
    }

    // ========== åˆå§‹åŒ– ==========
    function refreshRecords(showMessage = false) {
      if (!currentUser) return;
      
      const saved = localStorage.getItem('records_' + currentUser.id);
      records = saved ? JSON.parse(saved).map(ensureDataCompatibility) : [];
      
      // æ¯æ¬¡åŠ è½½åè®¡ç®—åˆ†æ‘Šè¿è´¹
      records = computeShippingAllocations(records);
      
      const savedTags = localStorage.getItem('tags');
      tags = saved ? JSON.parse(savedTags) : [];
      
      applyFilters();
      if (showMessage) alert('âœ… æ•°æ®å·²åˆ·æ–°');
    }

    window.addEventListener('load', () => {
      document.getElementById('authEmail').value = '';
      document.getElementById('authPassword').value = '';
      
      const saved = localStorage.getItem('currentUser');
      if (saved) {
        currentUser = JSON.parse(saved);
        setLoggedInUI(currentUser);
        refreshRecords(false);
      }
    });

    // å¤„ç†æ ‡ç­¾è¾“å…¥
    document.addEventListener('DOMContentLoaded', () => {
      renderTagsInput();
    });
  </script>
</body>
</html>
