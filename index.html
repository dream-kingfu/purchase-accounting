<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>è´­é”€è®°è´¦å·¥å…·ï¼ˆLeanCloud äº‘ç«¯ç‰ˆï¼‰</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    .container { max-width: 1200px; margin: 0 auto; }
    .header { text-align: center; color: white; margin-bottom: 18px; }
    .header h1 { font-size: 30px; margin-bottom: 8px; text-shadow: 0 2px 4px rgba(0,0,0,0.2); }
    .header p { font-size: 13px; opacity: 0.92; }

    .auth-bar {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 10px;
      align-items: center;
      margin-bottom: 18px;
    }
    @media (max-width: 768px) { .auth-bar { grid-template-columns: 1fr; } }

    .auth-info {
      background: rgba(255,255,255,0.12);
      border: 1px solid rgba(255,255,255,0.25);
      color: white;
      border-radius: 10px;
      padding: 12px 14px;
      font-size: 13px;
      line-height: 1.5;
      white-space: pre-line;
    }
    .auth-actions { display: flex; gap: 10px; flex-wrap: wrap; }
    .auth-actions .btn { width: auto; }

    .main-content { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
    @media (max-width: 1024px) { .main-content { grid-template-columns: 1fr; } }

    .card { background: white; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.1); padding: 25px; }
    .card h2 { font-size: 18px; color: #333; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #667eea; }

    .form-group { margin-bottom: 15px; }
    label { display: block; font-size: 13px; font-weight: 600; color: #555; margin-bottom: 6px; }

    input, select, textarea {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      font-family: inherit;
      transition: all 0.3s;
    }
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .btn {
      padding: 11px 20px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      width: 100%;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      user-select: none;
    }
    .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; margin-top: 10px; }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3); }
    .btn-secondary { background: #f0f0f0; color: #333; border: 1px solid #ddd; }
    .btn-secondary:hover { background: #e8e8e8; }
    .btn-danger { background: #ff6b6b; color: white; padding: 8px 12px; width: auto; font-size: 12px; }
    .btn-danger:hover { background: #ff5252; }
    .btn-white { background: white; color: #333; border: 1px solid rgba(255,255,255,0.55); }
    .btn-white:hover { background: #f3f3f3; }

    .btn-group { display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap; }
    .btn-group .btn { flex: 1; min-width: 180px; }

    table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 13px; }
    thead { background: #f8f9fa; }
    th { padding: 12px; text-align: left; font-weight: 600; color: #333; border-bottom: 2px solid #ddd; white-space: nowrap; }
    td { padding: 12px; border-bottom: 1px solid #eee; vertical-align: top; }
    tr:hover { background: #f9f9f9; }

    .profit-positive { color: #22c55e; font-weight: 600; }
    .profit-negative { color: #ff6b6b; font-weight: 600; }
    .empty-state { text-align: center; color: #999; padding: 30px; }
    .table-scroll { overflow-x: auto; }

    .success-message { background: #d4edda; color: #155724; padding: 12px 15px; border-radius: 6px; margin-bottom: 15px; display: none; }
    .success-message.show { display: block; }

    .error-message { background: #f8d7da; color: #721c24; padding: 12px 15px; border-radius: 6px; margin-bottom: 15px; display: none; }
    .error-message.show { display: block; }

    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
    .modal.active { display: flex; }
    .modal-content { background: white; border-radius: 12px; padding: 30px; max-width: 560px; width: 90%; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3); position: relative; }
    .modal-header { font-size: 20px; font-weight: 700; margin-bottom: 20px; color: #333; }
    .modal-close { position: absolute; top: 10px; right: 12px; background: none; border: none; font-size: 28px; cursor: pointer; color: #999; }
    .modal-body { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
    @media (max-width: 600px) { .modal-body { grid-template-columns: 1fr; } }
    .modal-actions { display: flex; gap: 10px; margin-top: 20px; }
    .modal-actions button { flex: 1; }

    .hidden {
      position: absolute !important;
      left: -9999px !important;
      width: 1px !important;
      height: 1px !important;
      opacity: 0 !important;
    }

    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 12px;
      border: 1px solid #ddd;
      background: #fafafa;
      color: #333;
      white-space: nowrap;
    }

    .filter-grid{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr 1fr;
      gap: 12px;
      margin-top: 10px;
    }
    @media (max-width: 1024px){
      .filter-grid{ grid-template-columns: 1fr 1fr; }
    }
    @media (max-width: 520px){
      .filter-grid{ grid-template-columns: 1fr; }
    }
    .filter-actions{
      display:flex;
      gap:10px;
      margin-top: 12px;
      flex-wrap: wrap;
    }
    .filter-actions .btn{ width:auto; }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ“Š è´­é”€è®°è´¦å·¥å…·</h1>
      <p>äº‘ç«¯ç‰ˆï¼ˆLeanCloud å›½å†…ç‰ˆï¼‰- å¤šè®¾å¤‡åŒæ­¥ / æ¯è´¦å·ç‹¬ç«‹ + åº“å­˜çŠ¶æ€ + ç­›é€‰</p>
    </div>

    <div class="auth-bar">
      <div class="auth-info" id="authInfo">æœªç™»å½•ï¼šè¯·å…ˆç™»å½•/æ³¨å†Œ</div>
      <div class="auth-actions">
        <button class="btn btn-white" id="btnOpenAuth">ç™»å½• / æ³¨å†Œ</button>
        <button class="btn btn-white" id="btnSignOut">é€€å‡ºç™»å½•</button>
      </div>
    </div>

    <div class="main-content hidden" id="appRoot">
      <!-- æ·»åŠ è®°å½• -->
      <div class="card">
        <h2>â• æ·»åŠ æ–°è®°å½•</h2>
        <div class="success-message" id="successMsg">âœ“ æ“ä½œæˆåŠŸ</div>
        <div class="error-message" id="errorMsg">âœ— æ“ä½œå¤±è´¥</div>

        <div class="form-group">
          <label>è´­ä¹°æ—¥æœŸ</label>
          <input type="date" id="buyDate" />
        </div>

        <div class="form-group">
          <label>è´­ä¹°å¹³å°</label>
          <select id="buyPlatform">
            <option value="">-- é€‰æ‹©å¹³å° --</option>
            <option value="æ·˜å®">æ·˜å®</option>
            <option value="äº¬ä¸œ">äº¬ä¸œ</option>
            <option value="æ‹¼å¤šå¤š">æ‹¼å¤šå¤š</option>
            <option value="å¾—ç‰©">å¾—ç‰©</option>
            <option value="æŠ–éŸ³å°åº—">æŠ–éŸ³å°åº—</option>
            <option value="å°çº¢ä¹¦">å°çº¢ä¹¦</option>
            <option value="äºšé©¬é€Š">äºšé©¬é€Š</option>
            <option value="eBay">eBay</option>
            <option value="å…¶ä»–">å…¶ä»–</option>
          </select>
        </div>

        <div class="form-group">
          <label>è´§å·</label>
          <input type="text" id="goodsCode" placeholder="å¦‚ï¼šDZ2024001" />
        </div>

        <div class="form-group">
          <label>å•†å“æè¿°</label>
          <textarea id="goodsDesc" placeholder="å•†å“åç§°ã€å‹å·ç­‰ä¿¡æ¯" rows="2"></textarea>
        </div>

        <div class="form-group">
          <label>åº“å­˜çŠ¶æ€</label>
          <select id="status">
            <option value="è¿è¾“ä¸­">è¿è¾“ä¸­</option>
            <option value="åœ¨ä»“åº“">åœ¨ä»“åº“</option>
            <option value="é—ªç”µä»“">é—ªç”µä»“</option>
            <option value="å·²å‡ºå”®">å·²å‡ºå”®</option>
            <option value="å·²æ‰“æ¬¾">å·²æ‰“æ¬¾</option>
          </select>
        </div>

        <div class="form-group">
          <label>ä»¶æ•°</label>
          <input type="number" id="quantity" value="1" min="1" step="1" />
        </div>

        <div class="form-group">
          <label>å•ä»¶æˆæœ¬ä»· (Â¥)</label>
          <input type="number" id="costPrice" placeholder="0.00" step="0.01" min="0" />
        </div>

        <div class="form-group">
          <label>ä»˜æ¬¾æ–¹å¼</label>
          <select id="paymentMethod">
            <option value="è‡ªä»˜">è‡ªä»˜</option>
            <option value="ç™½æ¡">ç™½æ¡</option>
            <option value="èŠ±å‘—">èŠ±å‘—</option>
          </select>
        </div>

        <div class="form-group">
          <label>å‡ºå”®æ—¥æœŸ <span style="color: #999; font-weight: normal;">(å¯é€‰)</span></label>
          <input type="date" id="sellDate" />
        </div>

        <div class="form-group">
          <label>å•ä»¶å”®å‡ºä»· <span style="color: #999; font-weight: normal;">(å¯é€‰)</span></label>
          <input type="number" id="sellPrice" placeholder="å¾…å¡«å†™" step="0.01" min="0" />
        </div>

        <div class="form-group">
          <label>å¤‡æ³¨</label>
          <input type="text" id="remark" placeholder="å…¶ä»–è¯´æ˜" />
        </div>

        <button class="btn btn-primary" id="btnAddRecord">æ·»åŠ è®°å½•</button>
      </div>

      <!-- æ•°æ®ç»Ÿè®¡ + çŠ¶æ€ç»Ÿè®¡ -->
      <div class="card">
        <h2>ğŸ“ˆ æ•°æ®ç»Ÿè®¡</h2>
        <div style="padding: 20px 0;">
          <div style="margin-bottom: 20px;">
            <div style="font-size: 12px; color: #666; margin-bottom: 5px;">ç­›é€‰åäº¤æ˜“ç¬”æ•°</div>
            <div style="font-size: 28px; font-weight: 700; color: #667eea;" id="totalCount">0</div>
          </div>

          <div style="margin-bottom: 20px;">
            <div style="font-size: 12px; color: #666; margin-bottom: 5px;">ç­›é€‰åä»¶æ•°</div>
            <div style="font-size: 28px; font-weight: 700; color: #667eea;" id="totalQuantity">0</div>
          </div>

          <div style="margin-bottom: 20px;">
            <div style="font-size: 12px; color: #666; margin-bottom: 5px;">ç­›é€‰åæ€»æˆæœ¬</div>
            <div style="font-size: 28px; font-weight: 700; color: #333;" id="totalCost">Â¥0.00</div>
          </div>

          <div style="margin-bottom: 20px;">
            <div style="font-size: 12px; color: #666; margin-bottom: 5px;">ç­›é€‰åæ€»æ”¶ç›Š</div>
            <div style="font-size: 28px; font-weight: 700; color: #22c55e;" id="totalRevenue">Â¥0.00</div>
          </div>

          <div>
            <div style="font-size: 12px; color: #666; margin-bottom: 5px;">ç­›é€‰åæ€»åˆ©æ¶¦ / å¹³å‡åˆ©æ¶¦ç‡</div>
            <div style="font-size: 20px; font-weight: 700; color: #764ba2;">
              <span id="totalProfit">Â¥0.00</span>
              <span style="margin-left: 8px;" id="avgProfitRate">0%</span>
            </div>
          </div>

          <div style="margin-top: 18px; padding-top: 14px; border-top: 1px solid #eee;">
            <div style="font-size: 12px; color: #666; margin-bottom: 10px;">å„çŠ¶æ€ä»¶æ•°ï¼ˆç­›é€‰åï¼‰</div>
            <div id="statusStats" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 10px;"></div>
          </div>
        </div>

        <div class="btn-group">
          <button class="btn btn-secondary" id="btnExport">ğŸ“¥ å¯¼å‡ºæ•°æ®</button>
          <label class="btn btn-secondary" for="importFile">ğŸ“¤ å¯¼å…¥æ•°æ®</label>
          <button class="btn btn-secondary" id="btnRefresh">ğŸ”„ åˆ·æ–°äº‘ç«¯æ•°æ®</button>
        </div>

        <input id="importFile" type="file" accept=".csv,.tsv,text/csv,text/tab-separated-values" class="hidden" />
      </div>

      <!-- è®°å½•åˆ—è¡¨ + ç­›é€‰ -->
      <div class="card" style="grid-column: 1 / -1;">
        <h2>ğŸ“‹ äº¤æ˜“è®°å½•</h2>

        <div class="filter-grid">
          <div class="form-group" style="margin-bottom:0;">
            <label>æŒ‰åº“å­˜çŠ¶æ€ç­›é€‰</label>
            <select id="filterStatus">
              <option value="å…¨éƒ¨">å…¨éƒ¨</option>
              <option value="è¿è¾“ä¸­">è¿è¾“ä¸­</option>
              <option value="åœ¨ä»“åº“">åœ¨ä»“åº“</option>
              <option value="é—ªç”µä»“">é—ªç”µä»“</option>
              <option value="å·²å‡ºå”®">å·²å‡ºå”®</option>
              <option value="å·²æ‰“æ¬¾">å·²æ‰“æ¬¾</option>
            </select>
          </div>

          <div class="form-group" style="margin-bottom:0;">
            <label>æŒ‰å¹³å°ç­›é€‰</label>
            <select id="filterPlatform">
              <option value="å…¨éƒ¨">å…¨éƒ¨</option>
              <option value="æ·˜å®">æ·˜å®</option>
              <option value="äº¬ä¸œ">äº¬ä¸œ</option>
              <option value="æ‹¼å¤šå¤š">æ‹¼å¤šå¤š</option>
              <option value="å¾—ç‰©">å¾—ç‰©</option>
              <option value="æŠ–éŸ³å°åº—">æŠ–éŸ³å°åº—</option>
              <option value="å°çº¢ä¹¦">å°çº¢ä¹¦</option>
              <option value="äºšé©¬é€Š">äºšé©¬é€Š</option>
              <option value="eBay">eBay</option>
              <option value="å…¶ä»–">å…¶ä»–</option>
            </select>
          </div>

          <div class="form-group" style="margin-bottom:0;">
            <label>æ˜¯å¦å·²å”®å‡º</label>
            <select id="filterSold">
              <option value="å…¨éƒ¨">å…¨éƒ¨</option>
              <option value="å·²å”®å‡º">å·²å”®å‡ºï¼ˆæœ‰å”®å‡ºä»·ï¼‰</option>
              <option value="æœªå”®å‡º">æœªå”®å‡ºï¼ˆæ— å”®å‡ºä»·ï¼‰</option>
            </select>
          </div>

          <div class="form-group" style="margin-bottom:0;">
            <label>å…³é”®å­—ï¼ˆè´§å·/æè¿°/å¤‡æ³¨ï¼‰</label>
            <input id="filterKeyword" type="text" placeholder="ä¾‹å¦‚ï¼šDZ2024 / Nike / è¡¥å•" value="" />
          </div>
        </div>

        <div class="filter-actions">
          <button class="btn btn-secondary" id="btnApplyFilters">åº”ç”¨ç­›é€‰</button>
          <button class="btn btn-secondary" id="btnResetFilters">æ¸…ç©ºç­›é€‰</button>
          <div style="align-self:center; font-size:12px; color:#666;">
            å½“å‰æ˜¾ç¤ºï¼š<span id="filteredCount">0</span> æ¡
          </div>
        </div>

        <div class="table-scroll">
          <table id="recordsTable">
            <thead>
              <tr>
                <th>åºå·</th>
                <th>è´­ä¹°æ—¥æœŸ</th>
                <th>å¹³å°</th>
                <th>è´§å·</th>
                <th>å•†å“æè¿°</th>
                <th>åº“å­˜çŠ¶æ€</th>
                <th>ä»¶æ•°</th>
                <th>å•ä»¶æˆæœ¬</th>
                <th>æ€»æˆæœ¬</th>
                <th>ä»˜æ¬¾æ–¹å¼</th>
                <th>å‡ºå”®æ—¥æœŸ</th>
                <th>å•ä»¶å”®å‡ºä»·</th>
                <th>æ€»å”®å‡ºä»·</th>
                <th>åˆ©æ¶¦</th>
                <th>åˆ©æ¶¦ç‡</th>
                <th style="width: 120px;">æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="tableBody">
              <tr class="empty-state">
                <td colspan="16">æš‚æ— æ•°æ®ï¼Œæ·»åŠ ç¬¬ä¸€æ¡è®°å½•å§</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ç™»å½•/æ³¨å†Œæ¨¡æ€æ¡† -->
    <div class="modal" id="authModal">
      <div class="modal-content">
        <button class="modal-close" id="btnCloseAuth">Ã—</button>
        <div class="modal-header">ç™»å½• / æ³¨å†Œï¼ˆLeanCloudï¼‰</div>

        <div class="form-group">
          <label>é‚®ç®±</label>
          <input type="email" id="authEmail" placeholder="you@example.com" />
        </div>

        <div class="form-group">
          <label>å¯†ç </label>
          <input type="password" id="authPassword" placeholder="è‡³å°‘ 6 ä½" />
        </div>

        <div class="modal-actions">
          <button class="btn btn-secondary" id="btnSignIn">ç™»å½•</button>
          <button class="btn btn-primary" id="btnSignUp">æ³¨å†Œ</button>
        </div>

        <div style="margin-top: 12px; font-size: 12px; color: #666; line-height: 1.6;">
          å¦‚ä½ åœ¨ LeanCloud å¼€å¯äº†é‚®ç®±éªŒè¯ï¼Œæ³¨å†Œåå¯èƒ½éœ€è¦å…ˆå»é‚®ç®±å®ŒæˆéªŒè¯ã€‚
        </div>
      </div>
    </div>

    <!-- ç¼–è¾‘è®°å½•æ¨¡æ€æ¡† -->
    <div class="modal" id="editModal">
      <div class="modal-content">
        <button class="modal-close" id="btnCloseEdit">Ã—</button>
        <div class="modal-header">ç¼–è¾‘è®°å½•</div>

        <div class="modal-body">
          <div class="form-group">
            <label>è´­ä¹°æ—¥æœŸ</label>
            <input type="date" id="editBuyDate" />
          </div>
          <div class="form-group">
            <label>è´­ä¹°å¹³å°</label>
            <select id="editBuyPlatform">
              <option value="æ·˜å®">æ·˜å®</option>
              <option value="äº¬ä¸œ">äº¬ä¸œ</option>
              <option value="æ‹¼å¤šå¤š">æ‹¼å¤šå¤š</option>
              <option value="å¾—ç‰©">å¾—ç‰©</option>
              <option value="æŠ–éŸ³å°åº—">æŠ–éŸ³å°åº—</option>
              <option value="å°çº¢ä¹¦">å°çº¢ä¹¦</option>
              <option value="äºšé©¬é€Š">äºšé©¬é€Š</option>
              <option value="eBay">eBay</option>
              <option value="å…¶ä»–">å…¶ä»–</option>
            </select>
          </div>

          <div class="form-group">
            <label>è´§å·</label>
            <input type="text" id="editGoodsCode" />
          </div>
          <div class="form-group">
            <label>å•†å“æè¿°</label>
            <input type="text" id="editGoodsDesc" />
          </div>

          <div class="form-group">
            <label>åº“å­˜çŠ¶æ€</label>
            <select id="editStatus">
              <option value="è¿è¾“ä¸­">è¿è¾“ä¸­</option>
              <option value="åœ¨ä»“åº“">åœ¨ä»“åº“</option>
              <option value="é—ªç”µä»“">é—ªç”µä»“</option>
              <option value="å·²å‡ºå”®">å·²å‡ºå”®</option>
              <option value="å·²æ‰“æ¬¾">å·²æ‰“æ¬¾</option>
            </select>
          </div>

          <div class="form-group">
            <label>ä»¶æ•°</label>
            <input type="number" id="editQuantity" min="1" step="1" />
          </div>

          <div class="form-group">
            <label>å•ä»¶æˆæœ¬ä»· (Â¥)</label>
            <input type="number" id="editCostPrice" step="0.01" min="0" />
          </div>

          <div class="form-group">
            <label>ä»˜æ¬¾æ–¹å¼</label>
            <select id="editPaymentMethod">
              <option value="è‡ªä»˜">è‡ªä»˜</option>
              <option value="ç™½æ¡">ç™½æ¡</option>
              <option value="èŠ±å‘—">èŠ±å‘—</option>
            </select>
          </div>

          <div class="form-group">
            <label>å‡ºå”®æ—¥æœŸ</label>
            <input type="date" id="editSellDate" />
          </div>
          <div class="form-group">
            <label>å•ä»¶å”®å‡ºä»· (Â¥)</label>
            <input type="number" id="editSellPrice" step="0.01" min="0" />
          </div>

          <div class="form-group" style="grid-column: 1 / -1;">
            <label>å¤‡æ³¨</label>
            <input type="text" id="editRemark" />
          </div>
        </div>

        <div class="modal-actions">
          <button class="btn btn-secondary" id="btnCancelEdit">å–æ¶ˆ</button>
          <button class="btn btn-primary" id="btnSaveRecord">ä¿å­˜ä¿®æ”¹</button>
        </div>
      </div>
    </div>

  </div>

  <!-- LeanCloud SDK -->
  <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4/dist/av-min.js"></script>

  <script>
    // ========== LeanCloud é…ç½®ï¼ˆå›½å†…ç‰ˆ CNï¼‰==========
    // âš ï¸ å¿…é¡»æ”¹è¿™ä¸‰ä¸ªå€¼ï¼šä»æ§åˆ¶å°å¤åˆ¶ä½ çš„ AppIDã€AppKeyã€Server URL
    const APP_ID = "RduftxqJEmEzb5TWtjpPQSgo-gzGzoHsz";                    // æ”¹æˆä½ çš„ AppID
    const APP_KEY = "IUFaRw1MluE2kOI0h1lyMnkf";                  // æ”¹æˆä½ çš„ AppKey
    const SERVER_URL = "https://rduftxqj.lc-cn-n1-shared.com";   // æ”¹æˆä½ çš„ Server URLï¼ˆæ§åˆ¶å°è·å–ï¼‰

    // åˆå§‹åŒ– LeanCloudï¼ˆå›½å†…ç‰ˆå¿…é¡»æä¾› serverURLï¼‰
    AV.init({ appId: APP_ID, appKey: APP_KEY, serverURL: SERVER_URL });

    let records = [];
    let filteredRecords = [];
    let editingRowId = null;
    let currentUser = null;

    // ========== å·¥å…·å‡½æ•° ==========
    function escapeHtml(str) {
      const div = document.createElement('div');
      div.textContent = str ?? '';
      return div.innerHTML;
    }

    function showMsg(text, isError = false) {
      const msg = isError ? document.getElementById('errorMsg') : document.getElementById('successMsg');
      msg.textContent = text;
      msg.classList.add('show');
      console.log(`[${isError ? 'ERROR' : 'SUCCESS'}] ${text}`);
      setTimeout(() => msg.classList.remove('show'), 2200);
    }

    // ========== UIæ§åˆ¶ ==========
    function setLoggedInUI(user) {
      const info = document.getElementById('authInfo');
      const root = document.getElementById('appRoot');
      if (user) {
        info.textContent = `å·²ç™»å½•ï¼š${user.getUsername()}\nï¼ˆæ•°æ®åœ¨äº‘ç«¯ï¼Œæ¢è®¾å¤‡ç™»å½•åŒè´¦å·å³å¯åŒæ­¥ï¼‰`;
        root.classList.remove('hidden');
      } else {
        info.textContent = 'æœªç™»å½•ï¼šè¯·å…ˆç™»å½•/æ³¨å†Œ';
        root.classList.add('hidden');
      }
    }

    // ========== è®¡ç®— ==========
    function calcDerived(record) {
      const q = Number(record.quantity || 0);
      const cost = Number(record.cost_price || 0);
      const sell = record.sell_price === null || record.sell_price === undefined ? null : Number(record.sell_price);

      const totalCost = cost * q;
      const totalSell = sell === null || Number.isNaN(sell) ? null : (sell * q);
      const profit = totalSell === null ? null : (totalSell - totalCost);
      const profitRate = totalSell === null || totalCost <= 0 ? null : (profit / totalCost * 100);
      return { totalCost, totalSell, profit, profitRate };
    }

    function statusBadge(status) {
      const s = (status || 'è¿è¾“ä¸­').trim();
      return `<span class="badge">${escapeHtml(s)}</span>`;
    }

    // ========== ç­›é€‰ ==========
    function applyFilters() {
      const status = document.getElementById('filterStatus').value;
      const platform = document.getElementById('filterPlatform').value;
      const sold = document.getElementById('filterSold').value;
      const keyword = document.getElementById('filterKeyword').value.trim().toLowerCase();

      filteredRecords = records.filter(r => {
        if (status !== 'å…¨éƒ¨' && (r.status || 'è¿è¾“ä¸­') !== status) return false;
        if (platform !== 'å…¨éƒ¨' && (r.buy_platform || '') !== platform) return false;

        const hasSell = !(r.sell_price === null || r.sell_price === undefined || r.sell_price === '');
        if (sold === 'å·²å”®å‡º' && !hasSell) return false;
        if (sold === 'æœªå”®å‡º' && hasSell) return false;

        if (keyword) {
          const hay = `${r.goods_code || ''} ${r.goods_desc || ''} ${r.remark || ''}`.toLowerCase();
          if (!hay.includes(keyword)) return false;
        }
        return true;
      });

      renderTable();
    }

    function resetFilters() {
      document.getElementById('filterStatus').value = 'å…¨éƒ¨';
      document.getElementById('filterPlatform').value = 'å…¨éƒ¨';
      document.getElementById('filterSold').value = 'å…¨éƒ¨';
      document.getElementById('filterKeyword').value = '';
      applyFilters();
    }

    // ========== çŠ¶æ€ç»Ÿè®¡ ==========
    function renderStatusStats() {
      const container = document.getElementById('statusStats');
      if (!container) return;

      const order = ['è¿è¾“ä¸­', 'åœ¨ä»“åº“', 'é—ªç”µä»“', 'å·²å‡ºå”®', 'å·²æ‰“æ¬¾'];

      const counts = (filteredRecords || []).reduce((acc, r) => {
        const s = (r.status || 'è¿è¾“ä¸­').trim();
        const q = Number(r.quantity || 0);
        acc[s] = (acc[s] || 0) + (Number.isFinite(q) ? q : 0);
        return acc;
      }, {});

      container.innerHTML = order.map(s => {
        const n = counts[s] || 0;
        return `
          <div style="border:1px solid #eee; border-radius:10px; padding:10px 12px; background:#fafafa;">
            <div style="font-size:12px; color:#666; margin-bottom:6px;">${escapeHtml(s)}</div>
            <div style="font-size:20px; font-weight:800; color:#333;">${n}</div>
          </div>
        `;
      }).join('');
    }

    // ========== ç»Ÿè®¡ ==========
    function updateStats() {
      const rows = filteredRecords || [];

      document.getElementById('filteredCount').textContent = rows.length;
      document.getElementById('totalCount').textContent = rows.length;

      let totalQty = 0;
      let totalCost = 0;
      let totalRevenue = 0;
      let totalProfit = 0;
      let profitRateSum = 0;
      let profitRateCount = 0;

      rows.forEach(r => {
        const q = Number(r.quantity || 0);
        totalQty += Number.isFinite(q) ? q : 0;

        const d = calcDerived(r);
        totalCost += d.totalCost || 0;
        if (d.totalSell !== null) totalRevenue += d.totalSell;
        if (d.profit !== null) totalProfit += d.profit;
        if (d.profitRate !== null) { profitRateSum += d.profitRate; profitRateCount++; }
      });

      document.getElementById('totalQuantity').textContent = totalQty;
      document.getElementById('totalCost').textContent = `Â¥${totalCost.toFixed(2)}`;
      document.getElementById('totalRevenue').textContent = `Â¥${totalRevenue.toFixed(2)}`;
      document.getElementById('totalProfit').textContent = `Â¥${totalProfit.toFixed(2)}`;
      document.getElementById('avgProfitRate').textContent =
        `${profitRateCount ? (profitRateSum / profitRateCount).toFixed(2) : '0.00'}%`;

      renderStatusStats();
    }

    // ========== è¡¨æ ¼æ¸²æŸ“ ==========
    function renderTable() {
      const tbody = document.getElementById('tableBody');
      const rows = filteredRecords || [];

      if (rows.length === 0) {
        tbody.innerHTML = `<tr class="empty-state"><td colspan="16">æš‚æ— æ•°æ®ï¼ˆå¯èƒ½è¢«ç­›é€‰æ¡ä»¶è¿‡æ»¤ï¼‰</td></tr>`;
        updateStats();
        return;
      }

      tbody.innerHTML = rows.map((r, idx) => {
        const d = calcDerived(r);

        const totalSellText = d.totalSell === null ? '' : `Â¥${d.totalSell.toFixed(2)}`;
        const profitText = d.profit === null ? '' : `Â¥${d.profit.toFixed(2)}`;
        const profitRateText = d.profitRate === null ? '' : `${d.profitRate.toFixed(2)}%`;

        const profitClass = (d.profit ?? 0) >= 0 ? 'profit-positive' : 'profit-negative';

        return `
          <tr>
            <td>${idx + 1}</td>
            <td>${escapeHtml(r.buy_date || '')}</td>
            <td>${escapeHtml(r.buy_platform || '')}</td>
            <td>${escapeHtml(r.goods_code || '')}</td>
            <td>${escapeHtml(r.goods_desc || '')}</td>
            <td>${statusBadge(r.status)}</td>
            <td>${Number(r.quantity || 0)}</td>
            <td>Â¥${Number(r.cost_price || 0).toFixed(2)}</td>
            <td>Â¥${d.totalCost.toFixed(2)}</td>
            <td>${escapeHtml(r.payment_method || 'è‡ªä»˜')}</td>
            <td>${escapeHtml(r.sell_date || '')}</td>
            <td>${r.sell_price !== null && r.sell_price !== undefined ? `Â¥${Number(r.sell_price).toFixed(2)}` : ''}</td>
            <td>${totalSellText}</td>
            <td class="${profitClass}">${profitText}</td>
            <td>${profitRateText}</td>
            <td>
              <button class="btn btn-danger" onclick="editRecord('${r.id}')">ç¼–è¾‘</button>
              <button class="btn btn-danger" onclick="deleteRecord('${r.id}')" style="margin-top: 4px;">åˆ é™¤</button>
            </td>
          </tr>
        `;
      }).join('');

      updateStats();
    }

    // ========== äº‘ç«¯è¯»å†™ ==========
    async function refreshRecords(showMessage = false) {
      if (!currentUser) {
        console.log('æœªç™»å½•ï¼Œè·³è¿‡åˆ·æ–°');
        return;
      }

      try {
        const Purchase = AV.Object.extend('purchases');
        
        // å…¼å®¹æ–°è€æ•°æ®ï¼šå…ˆæŸ¥ ownerï¼Œå†æŸ¥ user_idï¼ˆè€æ•°æ®æ²¡æœ‰ ownerï¼‰
        const query1 = new AV.Query(Purchase);
        query1.equalTo('owner', currentUser);
        
        const query2 = new AV.Query(Purchase);
        query2.equalTo('user_id', currentUser.id);
        
        const query = AV.Query.or(query1, query2);
        query.descending('createdAt');
        
        const data = await query.find();

        records = data.map(item => {
          const sp = item.get('sell_price');
          return {
            id: item.id,
            user_id: item.get('user_id') || '',
            buy_date: item.get('buy_date') || '',
            buy_platform: item.get('buy_platform') || '',
            goods_code: item.get('goods_code') || '',
            goods_desc: item.get('goods_desc') || '',
            status: item.get('status') || 'è¿è¾“ä¸­',
            quantity: item.get('quantity') || 0,
            cost_price: item.get('cost_price') || 0,
            payment_method: item.get('payment_method') || 'è‡ªä»˜',
            sell_date: item.get('sell_date') || '',
            sell_price: (sp === undefined ? null : sp),
            remark: item.get('remark') || ''
          };
        });

        console.log(`âœ“ æˆåŠŸä»äº‘ç«¯åŠ è½½ ${records.length} æ¡è®°å½•`);
        applyFilters();

        if (showMessage) showMsg('âœ“ å·²åˆ·æ–°äº‘ç«¯æ•°æ®');
      } catch (err) {
        console.error('âŒ åˆ·æ–°å¤±è´¥:', err);
        if (showMessage) showMsg('åˆ·æ–°å¤±è´¥ï¼š' + err.message, true);
      }
    }

    async function addRecord() {
      if (!currentUser) return alert('è¯·å…ˆç™»å½•');

      const buy_date = document.getElementById('buyDate').value;
      const buy_platform = document.getElementById('buyPlatform').value;
      const goods_code = document.getElementById('goodsCode').value;
      const goods_desc = document.getElementById('goodsDesc').value;
      const status = document.getElementById('status').value || 'è¿è¾“ä¸­';

      const quantity = parseInt(document.getElementById('quantity').value, 10) || 0;
      const cost_price = parseFloat(document.getElementById('costPrice').value) || 0;
      const payment_method = document.getElementById('paymentMethod').value || 'è‡ªä»˜';

      const sell_date = document.getElementById('sellDate').value || '';
      const sellPriceInput = document.getElementById('sellPrice').value;
      const sell_price = sellPriceInput === '' ? null : (parseFloat(sellPriceInput) || null);

      const remark = document.getElementById('remark').value;

      if (!buy_date || !buy_platform || !quantity || !cost_price) {
        alert('è¯·å¡«å†™å¿…è¦ä¿¡æ¯ï¼šè´­ä¹°æ—¥æœŸã€å¹³å°ã€ä»¶æ•°ã€æˆæœ¬ä»·\nå”®å‡ºä»·å¯ç¨åæ·»åŠ ');
        return;
      }

      console.log('ğŸ“ å¼€å§‹æ·»åŠ è®°å½•');

      try {
        const Purchase = AV.Object.extend('purchases');
        const record = new Purchase();
        
        record.set('user_id', currentUser.id);
        record.set('buy_date', buy_date);
        record.set('buy_platform', buy_platform);
        record.set('goods_code', goods_code);
        record.set('goods_desc', goods_desc);
        record.set('status', status);
        record.set('quantity', quantity);
        record.set('cost_price', Number(cost_price.toFixed(2)));
        record.set('payment_method', payment_method);
        record.set('sell_date', sell_date);
        record.set('sell_price', sell_price === null ? null : Number(sell_price.toFixed(2)));
        record.set('remark', remark);
        
        await record.save();

        console.log('âœ“ è®°å½•æ·»åŠ æˆåŠŸ');
        
        document.getElementById('buyDate').valueAsDate = new Date();
        document.getElementById('buyPlatform').value = '';
        document.getElementById('goodsCode').value = '';
        document.getElementById('goodsDesc').value = '';
        document.getElementById('status').value = 'è¿è¾“ä¸­';
        document.getElementById('quantity').value = 1;
        document.getElementById('costPrice').value = '';
        document.getElementById('paymentMethod').value = 'è‡ªä»˜';
        document.getElementById('sellDate').value = '';
        document.getElementById('sellPrice').value = '';
        document.getElementById('remark').value = '';

        showMsg('âœ“ è®°å½•å·²æ·»åŠ ï¼Œæ­£åœ¨åˆ·æ–°...');
        refreshRecords();
      } catch (err) {
        console.error('âŒ å¼‚å¸¸:', err);
        showMsg('æ“ä½œå¤±è´¥ï¼š' + err.message, true);
      }
    }

    function editRecord(rowId) {
      const record = records.find(r => r.id === rowId);
      if (!record) return;

      editingRowId = rowId;
      document.getElementById('editBuyDate').value = record.buy_date || '';
      document.getElementById('editBuyPlatform').value = record.buy_platform || 'æ·˜å®';
      document.getElementById('editGoodsCode').value = record.goods_code || '';
      document.getElementById('editGoodsDesc').value = record.goods_desc || '';
      document.getElementById('editStatus').value = record.status || 'è¿è¾“ä¸­';
      document.getElementById('editQuantity').value = record.quantity || 1;
      document.getElementById('editCostPrice').value = record.cost_price ?? 0;
      document.getElementById('editPaymentMethod').value = record.payment_method || 'è‡ªä»˜';
      document.getElementById('editSellDate').value = record.sell_date || '';
      document.getElementById('editSellPrice').value = record.sell_price ?? '';
      document.getElementById('editRemark').value = record.remark || '';
      document.getElementById('editModal').classList.add('active');
    }

    async function saveRecord() {
      if (editingRowId === null) return;

      const quantity = parseInt(document.getElementById('editQuantity').value, 10) || 0;
      const cost_price = parseFloat(document.getElementById('editCostPrice').value) || 0;
      if (!quantity || !cost_price) return alert('è¯·å¡«å†™ä»¶æ•°å’Œæˆæœ¬ä»·');

      const sellPriceInput = document.getElementById('editSellPrice').value;
      const sell_price = sellPriceInput === '' ? null : (parseFloat(sellPriceInput) || null);

      try {
        const Purchase = AV.Object.extend('purchases');
        const query = new AV.Query(Purchase);
        const record = await query.get(editingRowId);

        record.set('buy_date', document.getElementById('editBuyDate').value);
        record.set('buy_platform', document.getElementById('editBuyPlatform').value);
        record.set('goods_code', document.getElementById('editGoodsCode').value);
        record.set('goods_desc', document.getElementById('editGoodsDesc').value);
        record.set('status', document.getElementById('editStatus').value || 'è¿è¾“ä¸­');
        record.set('quantity', quantity);
        record.set('cost_price', Number(cost_price.toFixed(2)));
        record.set('payment_method', document.getElementById('editPaymentMethod').value || 'è‡ªä»˜');
        record.set('sell_date', document.getElementById('editSellDate').value || '');
        record.set('sell_price', sell_price === null ? null : Number(sell_price.toFixed(2)));
        record.set('remark', document.getElementById('editRemark').value);

        await record.save();

        document.getElementById('editModal').classList.remove('active');
        editingRowId = null;
        showMsg('âœ“ è®°å½•å·²æ›´æ–°');
        refreshRecords();
      } catch (err) {
        console.error('âŒ å¼‚å¸¸:', err);
        showMsg('æ“ä½œå¤±è´¥ï¼š' + err.message, true);
      }
    }

    async function deleteRecord(rowId) {
      if (!confirm('ç¡®è®¤åˆ é™¤æ­¤è®°å½•ï¼Ÿ')) return;
      
      try {
        const Purchase = AV.Object.extend('purchases');
        const query = new AV.Query(Purchase);
        const record = await query.get(rowId);
        await record.destroy();

        showMsg('âœ“ è®°å½•å·²åˆ é™¤');
        refreshRecords();
      } catch (err) {
        console.error('âŒ å¼‚å¸¸:', err);
        showMsg('æ“ä½œå¤±è´¥ï¼š' + err.message, true);
      }
    }

    // ========== Auth ==========
    async function signUp() {
      const email = document.getElementById('authEmail').value.trim();
      const password = document.getElementById('authPassword').value.trim();
      if (!email || !password) return alert('è¯·è¾“å…¥é‚®ç®±å’Œå¯†ç ');

      try {
        const user = new AV.User();
        user.setUsername(email);
        user.setPassword(password);
        user.setEmail(email);
        await user.signUp();
        
        currentUser = AV.User.current();
        document.getElementById('authModal').classList.remove('active');
        setLoggedInUI(currentUser);
        refreshRecords(false);
      } catch (err) {
        alert('æ³¨å†Œå¤±è´¥ï¼š' + err.message);
      }
    }

    async function signIn() {
      const email = document.getElementById('authEmail').value.trim();
      const password = document.getElementById('authPassword').value.trim();
      if (!email || !password) return alert('è¯·è¾“å…¥é‚®ç®±å’Œå¯†ç ');

      try {
        const user = await AV.User.logIn(email, password);
        currentUser = user;
        document.getElementById('authModal').classList.remove('active');
        setLoggedInUI(currentUser);
        refreshRecords(false);
      } catch (err) {
        alert('ç™»å½•å¤±è´¥ï¼š' + err.message);
      }
    }

    async function signOut() {
      try {
        await AV.User.logOut();
        currentUser = null;
        records = [];
        filteredRecords = [];
        renderTable();
        setLoggedInUI(null);
      } catch (err) {
        alert('é€€å‡ºç™»å½•å¤±è´¥ï¼š' + err.message);
      }
    }

    // ========== å¯¼å‡ºæ•°æ® ==========
    function exportData() {
      const rows = filteredRecords || [];
      if (rows.length === 0) return alert('æ²¡æœ‰æ•°æ®å¯å¯¼å‡º');

      const headers = ['è´­ä¹°æ—¥æœŸ', 'å¹³å°', 'è´§å·', 'å•†å“æè¿°', 'åº“å­˜çŠ¶æ€', 'ä»¶æ•°', 'å•ä»¶æˆæœ¬', 'æ€»æˆæœ¬', 'ä»˜æ¬¾æ–¹å¼', 'å‡ºå”®æ—¥æœŸ', 'å•ä»¶å”®å‡ºä»·', 'æ€»å”®å‡ºä»·', 'åˆ©æ¶¦', 'åˆ©æ¶¦ç‡', 'å¤‡æ³¨'];
      const csv = [headers.join('\t')];

      rows.forEach(r => {
        const d = calcDerived(r);
        const row = [
          r.buy_date || '',
          r.buy_platform || '',
          r.goods_code || '',
          r.goods_desc || '',
          r.status || '',
          r.quantity || 0,
          r.cost_price || 0,
          d.totalCost.toFixed(2),
          r.payment_method || 'è‡ªä»˜',
          r.sell_date || '',
          r.sell_price !== null && r.sell_price !== undefined ? r.sell_price.toFixed(2) : '',
          d.totalSell !== null ? d.totalSell.toFixed(2) : '',
          d.profit !== null ? d.profit.toFixed(2) : '',
          d.profitRate !== null ? d.profitRate.toFixed(2) : '',
          r.remark || ''
        ];
        csv.push(row.join('\t'));
      });

      const blob = new Blob([csv.join('\n')], { type: 'text/tab-separated-values;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `è´­é”€è®°è´¦_${new Date().toISOString().split('T')[0]}.tsv`;
      link.click();
      showMsg('âœ“ å·²å¯¼å‡ºæ•°æ®');
    }

    // ========== å¯¼å…¥æ•°æ® ==========
    document.getElementById('importFile').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const text = await file.text();
      const lines = text.split('\n').map(l => l.trim()).filter(l => l);
      if (lines.length < 2) return alert('æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®');

      if (!currentUser) return alert('è¯·å…ˆç™»å½•');

      const headerLine = lines[0];
      const isTab = headerLine.includes('\t');
      const delimiter = isTab ? '\t' : ',';

      const headers = headerLine.split(delimiter).map(h => h.trim());
      const required = ['è´­ä¹°æ—¥æœŸ', 'å¹³å°', 'ä»¶æ•°', 'å•ä»¶æˆæœ¬'];
      const allPresent = required.every(h => headers.includes(h));
      if (!allPresent) return alert(`æ–‡ä»¶å¿…é¡»åŒ…å«åˆ—ï¼š${required.join('ã€')}`);

      const rows = lines.slice(1).map(line => {
        const cells = line.split(delimiter).map(c => c.trim());
        const obj = {};
        headers.forEach((h, i) => {
          obj[h] = cells[i] || '';
        });
        return obj;
      });

      let success = 0;
      const Purchase = AV.Object.extend('purchases');

      for (const row of rows) {
        try {
          if (!row['è´­ä¹°æ—¥æœŸ'] || !row['å¹³å°'] || !row['ä»¶æ•°'] || !row['å•ä»¶æˆæœ¬']) continue;

          const record = new Purchase();
          record.set('user_id', currentUser.id);
          record.set('buy_date', row['è´­ä¹°æ—¥æœŸ']);
          record.set('buy_platform', row['å¹³å°']);
          record.set('goods_code', row['è´§å·'] || '');
          record.set('goods_desc', row['å•†å“æè¿°'] || '');
          record.set('status', row['åº“å­˜çŠ¶æ€'] || 'è¿è¾“ä¸­');
          record.set('quantity', parseInt(row['ä»¶æ•°'], 10) || 0);
          record.set('cost_price', parseFloat(row['å•ä»¶æˆæœ¬']) || 0);
          record.set('payment_method', row['ä»˜æ¬¾æ–¹å¼'] || 'è‡ªä»˜');
          record.set('sell_date', row['å‡ºå”®æ—¥æœŸ'] || '');
          record.set('sell_price', row['å•ä»¶å”®å‡ºä»·'] ? parseFloat(row['å•ä»¶å”®å‡ºä»·']) : null);
          record.set('remark', row['å¤‡æ³¨'] || '');

          await record.save();
          success++;
        } catch (err) {
          console.error('å¯¼å…¥è¡Œå‡ºé”™:', err);
        }
      }

      alert(`å¯¼å…¥å®Œæˆï¼š${success}/${rows.length} æ¡è®°å½•`);
      e.target.value = '';
      refreshRecords(false);
    });

    // ========== åˆå§‹åŒ– ==========
    console.log('ğŸš€ åº”ç”¨æ­£åœ¨åˆå§‹åŒ–...');
    
    // è´­ä¹°æ—¥æœŸé»˜è®¤ä»Šå¤©
    document.getElementById('buyDate').valueAsDate = new Date();
    // å”®å‡ºæ—¥æœŸä¿æŒç©ºï¼ˆæœªå‡ºå”®ï¼‰
    document.getElementById('sellDate').value = '';

    // æ¸…ç©ºç™»å½•è¡¨å•
    document.getElementById('authEmail').value = '';
    document.getElementById('authPassword').value = '';

    currentUser = AV.User.current();
    setLoggedInUI(currentUser);
    if (currentUser) {
      console.log('å·²æ£€æµ‹åˆ°ç™»å½•çŠ¶æ€ï¼Œæ­£åœ¨åŠ è½½æ•°æ®...');
      refreshRecords(false);
    }
</parameter>

    // ========== äº‹ä»¶ç»‘å®š ==========
    document.getElementById('btnOpenAuth').addEventListener('click', () => {
      document.getElementById('authModal').classList.add('active');
    });

    document.getElementById('btnCloseAuth').addEventListener('click', () => {
      document.getElementById('authModal').classList.remove('active');
    });

    document.getElementById('btnSignUp').addEventListener('click', signUp);
    document.getElementById('btnSignIn').addEventListener('click', signIn);
    document.getElementById('btnSignOut').addEventListener('click', signOut);

    document.getElementById('btnAddRecord').addEventListener('click', addRecord);
    document.getElementById('btnExport').addEventListener('click', exportData);
    document.getElementById('btnRefresh').addEventListener('click', () => refreshRecords(true));

    document.getElementById('btnApplyFilters').addEventListener('click', applyFilters);
    document.getElementById('btnResetFilters').addEventListener('click', resetFilters);

    document.getElementById('btnCloseEdit').addEventListener('click', () => {
      document.getElementById('editModal').classList.remove('active');
      editingRowId = null;
    });

    document.getElementById('btnCancelEdit').addEventListener('click', () => {
      document.getElementById('editModal').classList.remove('active');
      editingRowId = null;
    });

    document.getElementById('btnSaveRecord').addEventListener('click', saveRecord);

    // è¿‡æ»¤å™¨è‡ªåŠ¨è§¦å‘
    ['filterStatus','filterPlatform','filterSold','filterKeyword'].forEach(id => {
      const el = document.getElementById(id);
      if (!el) return;
      el.addEventListener('input', applyFilters);
      el.addEventListener('change', applyFilters);
    });

    // æš´éœ²å…¨å±€å‡½æ•°ï¼ˆç»™è¡¨æ ¼é‡Œçš„onclickç”¨ï¼‰
    window.editRecord = editRecord;
    window.deleteRecord = deleteRecord;

    console.log('âœ… åˆå§‹åŒ–å®Œæˆï¼');
  </script>
</body>
</html>
