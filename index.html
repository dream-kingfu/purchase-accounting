<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>è´­é”€è®°è´¦å·¥å…·ï¼ˆäº‘ç«¯ Supabaseï¼‰</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    .container { max-width: 1200px; margin: 0 auto; }
    .header { text-align: center; color: white; margin-bottom: 18px; }
    .header h1 { font-size: 30px; margin-bottom: 8px; text-shadow: 0 2px 4px rgba(0,0,0,0.2); }
    .header p { font-size: 13px; opacity: 0.92; }

    .auth-bar {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 10px;
      align-items: center;
      margin-bottom: 18px;
    }
    @media (max-width: 768px) { .auth-bar { grid-template-columns: 1fr; } }

    .auth-info {
      background: rgba(255,255,255,0.12);
      border: 1px solid rgba(255,255,255,0.25);
      color: white;
      border-radius: 10px;
      padding: 12px 14px;
      font-size: 13px;
      line-height: 1.5;
      white-space: pre-line;
    }
    .auth-actions { display: flex; gap: 10px; flex-wrap: wrap; }
    .auth-actions .btn { width: auto; }

    .main-content { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
    @media (max-width: 1024px) { .main-content { grid-template-columns: 1fr; } }

    .card { background: white; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.1); padding: 25px; }
    .card h2 { font-size: 18px; color: #333; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #667eea; }

    .form-group { margin-bottom: 15px; }
    label { display: block; font-size: 13px; font-weight: 600; color: #555; margin-bottom: 6px; }

    input, select, textarea {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      font-family: inherit;
      transition: all 0.3s;
    }
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .btn {
      padding: 11px 20px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      width: 100%;
    }
    .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; margin-top: 10px; }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3); }
    .btn-secondary { background: #f0f0f0; color: #333; border: 1px solid #ddd; }
    .btn-secondary:hover { background: #e8e8e8; }
    .btn-danger { background: #ff6b6b; color: white; padding: 8px 12px; width: auto; font-size: 12px; }
    .btn-danger:hover { background: #ff5252; }
    .btn-white { background: white; color: #333; border: 1px solid rgba(255,255,255,0.55); }
    .btn-white:hover { background: #f3f3f3; }

    .btn-group { display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap; }
    .btn-group .btn { flex: 1; min-width: 180px; }

    table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 13px; }
    thead { background: #f8f9fa; }
    th { padding: 12px; text-align: left; font-weight: 600; color: #333; border-bottom: 2px solid #ddd; white-space: nowrap; }
    td { padding: 12px; border-bottom: 1px solid #eee; vertical-align: top; }
    tr:hover { background: #f9f9f9; }

    .profit-positive { color: #22c55e; font-weight: 600; }
    .profit-negative { color: #ff6b6b; font-weight: 600; }
    .empty-state { text-align: center; color: #999; padding: 30px; }
    .table-scroll { overflow-x: auto; }

    .success-message { background: #d4edda; color: #155724; padding: 12px 15px; border-radius: 6px; margin-bottom: 15px; display: none; }
    .success-message.show { display: block; }

    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
    .modal.active { display: flex; }
    .modal-content { background: white; border-radius: 12px; padding: 30px; max-width: 560px; width: 90%; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3); position: relative; }
    .modal-header { font-size: 20px; font-weight: 700; margin-bottom: 20px; color: #333; }
    .modal-close { position: absolute; top: 10px; right: 12px; background: none; border: none; font-size: 28px; cursor: pointer; color: #999; }
    .modal-body { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
    @media (max-width: 600px) { .modal-body { grid-template-columns: 1fr; } }
    .modal-actions { display: flex; gap: 10px; margin-top: 20px; }
    .modal-actions button { flex: 1; }

    .hidden { display: none !important; }
    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 12px;
      border: 1px solid #ddd;
      background: #fafafa;
      color: #333;
      white-space: nowrap;
    }

    .filter-grid{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr 1fr;
      gap: 12px;
      margin-top: 10px;
    }
    @media (max-width: 1024px){
      .filter-grid{ grid-template-columns: 1fr 1fr; }
    }
    @media (max-width: 520px){
      .filter-grid{ grid-template-columns: 1fr; }
    }
    .filter-actions{
      display:flex;
      gap:10px;
      margin-top: 12px;
      flex-wrap: wrap;
    }
    .filter-actions .btn{ width:auto; }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ“Š è´­é”€è®°è´¦å·¥å…·</h1>
      <p>äº‘ç«¯ç‰ˆï¼ˆSupabaseï¼‰- å¤šè®¾å¤‡åŒæ­¥ / æ¯è´¦å·ç‹¬ç«‹ + åº“å­˜çŠ¶æ€ + ç­›é€‰</p>
    </div>

    <div class="auth-bar">
      <div class="auth-info" id="authInfo">æœªç™»å½•ï¼šè¯·å…ˆç™»å½•/æ³¨å†Œ</div>
      <div class="auth-actions">
        <button class="btn btn-white" onclick="openAuthModal()">ç™»å½• / æ³¨å†Œ</button>
        <button class="btn btn-white" onclick="signOut()">é€€å‡ºç™»å½•</button>
      </div>
    </div>

    <div class="main-content hidden" id="appRoot">
      <!-- æ·»åŠ è®°å½• -->
      <div class="card">
        <h2>â• æ·»åŠ æ–°è®°å½•</h2>
        <div class="success-message" id="successMsg">âœ“ æ“ä½œæˆåŠŸ</div>

        <div class="form-group">
          <label>è´­ä¹°æ—¥æœŸ</label>
          <input type="date" id="buyDate" />
        </div>

        <div class="form-group">
          <label>è´­ä¹°å¹³å°</label>
          <select id="buyPlatform">
            <option value="">-- é€‰æ‹©å¹³å° --</option>
            <option value="æ·˜å®">æ·˜å®</option>
            <option value="äº¬ä¸œ">äº¬ä¸œ</option>
            <option value="æ‹¼å¤šå¤š">æ‹¼å¤šå¤š</option>
            <option value="å¾—ç‰©">å¾—ç‰©</option>
            <option value="æŠ–éŸ³å°åº—">æŠ–éŸ³å°åº—</option>
            <option value="å°çº¢ä¹¦">å°çº¢ä¹¦</option>
            <option value="äºšé©¬é€Š">äºšé©¬é€Š</option>
            <option value="eBay">eBay</option>
            <option value="å…¶ä»–">å…¶ä»–</option>
          </select>
        </div>

        <div class="form-group">
          <label>è´§å·</label>
          <input type="text" id="goodsCode" placeholder="å¦‚ï¼šDZ2024001" />
        </div>

        <div class="form-group">
          <label>å•†å“æè¿°</label>
          <textarea id="goodsDesc" placeholder="å•†å“åç§°ã€å‹å·ç­‰ä¿¡æ¯" rows="2"></textarea>
        </div>

        <div class="form-group">
          <label>åº“å­˜çŠ¶æ€</label>
          <select id="status">
            <option value="è¿è¾“ä¸­">è¿è¾“ä¸­</option>
            <option value="åœ¨ä»“åº“">åœ¨ä»“åº“</option>
            <option value="é—ªç”µä»“">é—ªç”µä»“</option>
            <option value="å·²å‡ºå”®">å·²å‡ºå”®</option>
            <option value="å·²æ‰“æ¬¾">å·²æ‰“æ¬¾</option>
          </select>
        </div>

        <div class="form-group">
          <label>ä»¶æ•°</label>
          <input type="number" id="quantity" value="1" min="1" step="1" />
        </div>

        <div class="form-group">
          <label>å•ä»¶æˆæœ¬ä»· (Â¥)</label>
          <input type="number" id="costPrice" placeholder="0.00" step="0.01" min="0" />
        </div>

        <div class="form-group">
          <label>å‡ºå”®æ—¥æœŸ <span style="color: #999; font-weight: normal;">(å¯é€‰)</span></label>
          <input type="date" id="sellDate" />
        </div>

        <div class="form-group">
          <label>å•ä»¶å”®å‡ºä»· <span style="color: #999; font-weight: normal;">(å¯é€‰)</span></label>
          <input type="number" id="sellPrice" placeholder="å¾…å¡«å†™" step="0.01" min="0" />
        </div>

        <div class="form-group">
          <label>å¤‡æ³¨</label>
          <input type="text" id="remark" placeholder="å…¶ä»–è¯´æ˜" />
        </div>

        <button class="btn btn-primary" onclick="addRecord()">æ·»åŠ è®°å½•</button>
      </div>

      <!-- æ•°æ®ç»Ÿè®¡ + çŠ¶æ€ç»Ÿè®¡ -->
      <div class="card">
        <h2>ğŸ“ˆ æ•°æ®ç»Ÿè®¡</h2>
        <div style="padding: 20px 0;">
          <div style="margin-bottom: 20px;">
            <div style="font-size: 12px; color: #666; margin-bottom: 5px;">ç­›é€‰åäº¤æ˜“ç¬”æ•°</div>
            <div style="font-size: 28px; font-weight: 700; color: #667eea;" id="totalCount">0</div>
          </div>

          <div style="margin-bottom: 20px;">
            <div style="font-size: 12px; color: #666; margin-bottom: 5px;">ç­›é€‰åä»¶æ•°</div>
            <div style="font-size: 28px; font-weight: 700; color: #667eea;" id="totalQuantity">0</div>
          </div>

          <div style="margin-bottom: 20px;">
            <div style="font-size: 12px; color: #666; margin-bottom: 5px;">ç­›é€‰åæ€»æˆæœ¬</div>
            <div style="font-size: 28px; font-weight: 700; color: #333;" id="totalCost">Â¥0.00</div>
          </div>

          <div style="margin-bottom: 20px;">
            <div style="font-size: 12px; color: #666; margin-bottom: 5px;">ç­›é€‰åæ€»æ”¶ç›Š</div>
            <div style="font-size: 28px; font-weight: 700; color: #22c55e;" id="totalRevenue">Â¥0.00</div>
          </div>

          <div>
            <div style="font-size: 12px; color: #666; margin-bottom: 5px;">ç­›é€‰åæ€»åˆ©æ¶¦ / å¹³å‡åˆ©æ¶¦ç‡</div>
            <div style="font-size: 20px; font-weight: 700; color: #764ba2;">
              <span id="totalProfit">Â¥0.00</span>
              <span style="margin-left: 8px;" id="avgProfitRate">0%</span>
            </div>
          </div>

          <div style="margin-top: 18px; padding-top: 14px; border-top: 1px solid #eee;">
            <div style="font-size: 12px; color: #666; margin-bottom: 10px;">å„çŠ¶æ€ä»¶æ•°ï¼ˆç­›é€‰åï¼‰</div>
            <div id="statusStats" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 10px;"></div>
          </div>
        </div>

        <div class="btn-group">
          <button class="btn btn-secondary" onclick="exportData()">ğŸ“¥ å¯¼å‡ºæ•°æ®</button>
          <button class="btn btn-secondary" onclick="triggerImport()">ğŸ“¤ å¯¼å…¥æ•°æ®</button>
          <button class="btn btn-secondary" onclick="refreshRecords()">ğŸ”„ åˆ·æ–°äº‘ç«¯æ•°æ®</button>
        </div>

        <input id="importFile" type="file" accept=".csv,.tsv,text/csv,text/tab-separated-values" class="hidden" />
      </div>

      <!-- è®°å½•åˆ—è¡¨ + ç­›é€‰ -->
      <div class="card" style="grid-column: 1 / -1;">
        <h2>ğŸ“‹ äº¤æ˜“è®°å½•</h2>

        <div class="filter-grid">
          <div class="form-group" style="margin-bottom:0;">
            <label>æŒ‰åº“å­˜çŠ¶æ€ç­›é€‰</label>
            <select id="filterStatus">
              <option value="å…¨éƒ¨">å…¨éƒ¨</option>
              <option value="è¿è¾“ä¸­">è¿è¾“ä¸­</option>
              <option value="åœ¨ä»“åº“">åœ¨ä»“åº“</option>
              <option value="é—ªç”µä»“">é—ªç”µä»“</option>
              <option value="å·²å‡ºå”®">å·²å‡ºå”®</option>
              <option value="å·²æ‰“æ¬¾">å·²æ‰“æ¬¾</option>
            </select>
          </div>

          <div class="form-group" style="margin-bottom:0;">
            <label>æŒ‰å¹³å°ç­›é€‰</label>
            <select id="filterPlatform">
              <option value="å…¨éƒ¨">å…¨éƒ¨</option>
              <option value="æ·˜å®">æ·˜å®</option>
              <option value="äº¬ä¸œ">äº¬ä¸œ</option>
              <option value="æ‹¼å¤šå¤š">æ‹¼å¤šå¤š</option>
              <option value="å¾—ç‰©">å¾—ç‰©</option>
              <option value="æŠ–éŸ³å°åº—">æŠ–éŸ³å°åº—</option>
              <option value="å°çº¢ä¹¦">å°çº¢ä¹¦</option>
              <option value="äºšé©¬é€Š">äºšé©¬é€Š</option>
              <option value="eBay">eBay</option>
              <option value="å…¶ä»–">å…¶ä»–</option>
            </select>
          </div>

          <div class="form-group" style="margin-bottom:0;">
            <label>æ˜¯å¦å·²å”®å‡º</label>
            <select id="filterSold">
              <option value="å…¨éƒ¨">å…¨éƒ¨</option>
              <option value="å·²å”®å‡º">å·²å”®å‡ºï¼ˆæœ‰å”®å‡ºä»·ï¼‰</option>
              <option value="æœªå”®å‡º">æœªå”®å‡ºï¼ˆæ— å”®å‡ºä»·ï¼‰</option>
            </select>
          </div>

          <div class="form-group" style="margin-bottom:0;">
            <label>å…³é”®å­—ï¼ˆè´§å·/æè¿°/å¤‡æ³¨ï¼‰</label>
            <input id="filterKeyword" type="text" placeholder="ä¾‹å¦‚ï¼šDZ2024 / Nike / è¡¥å•" />
          </div>
        </div>

        <div class="filter-actions">
          <button class="btn btn-secondary" onclick="applyFilters()">åº”ç”¨ç­›é€‰</button>
          <button class="btn btn-secondary" onclick="resetFilters()">æ¸…ç©ºç­›é€‰</button>
          <div style="align-self:center; font-size:12px; color:#666;">
            å½“å‰æ˜¾ç¤ºï¼š<span id="filteredCount">0</span> æ¡
          </div>
        </div>

        <div class="table-scroll">
          <table id="recordsTable">
            <thead>
              <tr>
                <th>åºå·</th>
                <th>è´­ä¹°æ—¥æœŸ</th>
                <th>å¹³å°</th>
                <th>è´§å·</th>
                <th>å•†å“æè¿°</th>
                <th>åº“å­˜çŠ¶æ€</th>
                <th>ä»¶æ•°</th>
                <th>å•ä»¶æˆæœ¬</th>
                <th>æ€»æˆæœ¬</th>
                <th>å‡ºå”®æ—¥æœŸ</th>
                <th>å•ä»¶å”®å‡ºä»·</th>
                <th>æ€»å”®å‡ºä»·</th>
                <th>åˆ©æ¶¦</th>
                <th>åˆ©æ¶¦ç‡</th>
                <th style="width: 120px;">æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="tableBody">
              <tr class="empty-state">
                <td colspan="15">æš‚æ— æ•°æ®ï¼Œæ·»åŠ ç¬¬ä¸€æ¡è®°å½•å§ ğŸ‘†</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ç™»å½•/æ³¨å†Œæ¨¡æ€æ¡† -->
    <div class="modal" id="authModal">
      <div class="modal-content">
        <button class="modal-close" onclick="closeAuthModal()">Ã—</button>
        <div class="modal-header">ç™»å½• / æ³¨å†Œï¼ˆSupabaseï¼‰</div>

        <div class="form-group">
          <label>é‚®ç®±</label>
          <input type="email" id="authEmail" placeholder="you@example.com" />
        </div>

        <div class="form-group">
          <label>å¯†ç </label>
          <input type="password" id="authPassword" placeholder="è‡³å°‘ 6 ä½" />
        </div>

        <div class="modal-actions">
          <button class="btn btn-secondary" onclick="signIn()">ç™»å½•</button>
          <button class="btn btn-primary" onclick="signUp()">æ³¨å†Œ</button>
        </div>

        <div style="margin-top: 12px; font-size: 12px; color: #666; line-height: 1.6;">
          å¦‚æœä½ åœ¨ Supabase å¼€å¯äº†é‚®ç®±éªŒè¯ï¼Œæ³¨å†Œåéœ€è¦å…ˆå»é‚®ç®±ç¡®è®¤é“¾æ¥æ‰èƒ½ç™»å½•ã€‚
        </div>
      </div>
    </div>

    <!-- ç¼–è¾‘è®°å½•æ¨¡æ€æ¡† -->
    <div class="modal" id="editModal">
      <div class="modal-content">
        <button class="modal-close" onclick="closeEditModal()">Ã—</button>
        <div class="modal-header">ç¼–è¾‘è®°å½•</div>

        <div class="modal-body">
          <div class="form-group">
            <label>è´­ä¹°æ—¥æœŸ</label>
            <input type="date" id="editBuyDate" />
          </div>
          <div class="form-group">
            <label>è´­ä¹°å¹³å°</label>
            <select id="editBuyPlatform">
              <option value="æ·˜å®">æ·˜å®</option>
              <option value="äº¬ä¸œ">äº¬ä¸œ</option>
              <option value="æ‹¼å¤šå¤š">æ‹¼å¤šå¤š</option>
              <option value="å¾—ç‰©">å¾—ç‰©</option>
              <option value="æŠ–éŸ³å°åº—">æŠ–éŸ³å°åº—</option>
              <option value="å°çº¢ä¹¦">å°çº¢ä¹¦</option>
              <option value="äºšé©¬é€Š">äºšé©¬é€Š</option>
              <option value="eBay">eBay</option>
              <option value="å…¶ä»–">å…¶ä»–</option>
            </select>
          </div>

          <div class="form-group">
            <label>è´§å·</label>
            <input type="text" id="editGoodsCode" />
          </div>
          <div class="form-group">
            <label>å•†å“æè¿°</label>
            <input type="text" id="editGoodsDesc" />
          </div>

          <div class="form-group">
            <label>åº“å­˜çŠ¶æ€</label>
            <select id="editStatus">
              <option value="è¿è¾“ä¸­">è¿è¾“ä¸­</option>
              <option value="åœ¨ä»“åº“">åœ¨ä»“åº“</option>
              <option value="é—ªç”µä»“">é—ªç”µä»“</option>
              <option value="å·²å‡ºå”®">å·²å‡ºå”®</option>
              <option value="å·²æ‰“æ¬¾">å·²æ‰“æ¬¾</option>
            </select>
          </div>

          <div class="form-group">
            <label>ä»¶æ•°</label>
            <input type="number" id="editQuantity" min="1" step="1" />
          </div>

          <div class="form-group">
            <label>å•ä»¶æˆæœ¬ä»· (Â¥)</label>
            <input type="number" id="editCostPrice" step="0.01" min="0" />
          </div>

          <div class="form-group">
            <label>å‡ºå”®æ—¥æœŸ</label>
            <input type="date" id="editSellDate" />
          </div>
          <div class="form-group">
            <label>å•ä»¶å”®å‡ºä»· (Â¥)</label>
            <input type="number" id="editSellPrice" step="0.01" min="0" />
          </div>

          <div class="form-group" style="grid-column: 1 / -1;">
            <label>å¤‡æ³¨</label>
            <input type="text" id="editRemark" />
          </div>
        </div>

        <div class="modal-actions">
          <button class="btn btn-secondary" onclick="closeEditModal()">å–æ¶ˆ</button>
          <button class="btn btn-primary" onclick="saveRecord()">ä¿å­˜ä¿®æ”¹</button>
        </div>
      </div>
    </div>

  </div>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    // === ä½ çš„ Supabase ä¿¡æ¯ ===
    const SUPABASE_URL = "https://tpvodhwikbhigdxcthsk.supabase.co";
    const SUPABASE_KEY = "sb_publishable_kiSkcXCRrrfdbsOAfjuNnw_pSHDoTNa";
    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY); // createClient(url,key) [web:208]

    let records = [];
    let filteredRecords = [];
    let editingRowId = null;

    // åˆå§‹åŒ–æ—¥æœŸ
    document.getElementById('buyDate').valueAsDate = new Date();
    document.getElementById('sellDate').valueAsDate = new Date();

    // è¿‡æ»¤å™¨ï¼šè¾“å…¥å˜åŒ–å³åº”ç”¨ï¼ˆä¹Ÿä¿ç•™æŒ‰é’®ï¼‰
    ['filterStatus','filterPlatform','filterSold','filterKeyword'].forEach(id => {
      const el = document.getElementById(id);
      if (!el) return;
      el.addEventListener('input', () => applyFilters());
      el.addEventListener('change', () => applyFilters());
    });

    // ---------- UI ----------
    function showMsg(text) {
      const msg = document.getElementById('successMsg');
      msg.textContent = text;
      msg.classList.add('show');
      setTimeout(() => msg.classList.remove('show'), 2200);
    }

    window.openAuthModal = () => document.getElementById('authModal').classList.add('active');
    window.closeAuthModal = () => document.getElementById('authModal').classList.remove('active');

    function setLoggedInUI(user) {
      const info = document.getElementById('authInfo');
      const root = document.getElementById('appRoot');
      if (user) {
        info.textContent = `å·²ç™»å½•ï¼š${user.email}\nï¼ˆæ•°æ®åœ¨äº‘ç«¯ï¼Œæ¢è®¾å¤‡ç™»å½•åŒè´¦å·å³å¯åŒæ­¥ï¼‰`;
        root.classList.remove('hidden');
      } else {
        info.textContent = 'æœªç™»å½•ï¼šè¯·å…ˆç™»å½•/æ³¨å†Œ';
        root.classList.add('hidden');
      }
    }

    // ---------- Auth ----------
    window.signUp = async function () {
      const email = document.getElementById('authEmail').value.trim();
      const password = document.getElementById('authPassword').value.trim();
      if (!email || !password) return alert('è¯·è¾“å…¥é‚®ç®±å’Œå¯†ç ');

      const { error } = await supabase.auth.signUp({ email, password });
      if (error) return alert(error.message);
      alert('æ³¨å†ŒæˆåŠŸã€‚è‹¥å¯ç”¨é‚®ç®±éªŒè¯ï¼Œè¯·å…ˆå»é‚®ç®±ç¡®è®¤åå†ç™»å½•ã€‚');
    };

    window.signIn = async function () {
      const email = document.getElementById('authEmail').value.trim();
      const password = document.getElementById('authPassword').value.trim();
      if (!email || !password) return alert('è¯·è¾“å…¥é‚®ç®±å’Œå¯†ç ');

      const { error } = await supabase.auth.signInWithPassword({ email, password });
      if (error) return alert(error.message);

      window.closeAuthModal();
      await refreshRecords();
    };

    window.signOut = async function () {
      await supabase.auth.signOut();
      records = [];
      filteredRecords = [];
      renderTable();
      setLoggedInUI(null);
    };

    // ç›‘å¬ç™»å½•çŠ¶æ€å˜åŒ–ï¼ˆSupabase æ¨èçš„äº‹ä»¶æ–¹å¼ï¼‰[web:662]
    supabase.auth.onAuthStateChange(async (_event, session) => {
      setLoggedInUI(session?.user ?? null);
      if (session?.user) await refreshRecords();
    });

    const { data: { session } } = await supabase.auth.getSession();
    setLoggedInUI(session?.user ?? null);
    if (session?.user) await refreshRecords();

    // ---------- è®¡ç®— ----------
    function calcDerived(record) {
      const q = Number(record.quantity || 0);
      const cost = Number(record.cost_price || 0);
      const sell = record.sell_price === null || record.sell_price === undefined ? null : Number(record.sell_price);

      const totalCost = cost * q;
      const totalSell = sell === null || Number.isNaN(sell) ? null : (sell * q);
      const profit = totalSell === null ? null : (totalSell - totalCost);
      const profitRate = totalSell === null || totalCost <= 0 ? null : (profit / totalCost * 100);
      return { totalCost, totalSell, profit, profitRate };
    }

    function statusBadge(status) {
      const s = (status || 'è¿è¾“ä¸­').trim();
      return `<span class="badge">${escapeHtml(s)}</span>`;
    }

    // ---------- äº‘ç«¯è¯»å†™ ----------
    window.refreshRecords = async function () {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) return;

      const { data, error } = await supabase
        .from('purchases')
        .select('*')
        .order('created_at', { ascending: false });

      if (error) return alert(error.message);

      records = data || [];
      applyFilters(); // è‡ªåŠ¨åˆ·æ–°ç­›é€‰ç»“æœå¹¶æ¸²æŸ“
      showMsg('âœ“ å·²åˆ·æ–°äº‘ç«¯æ•°æ®');
    };

    window.addRecord = async function () {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) return alert('è¯·å…ˆç™»å½•');

      const buy_date = document.getElementById('buyDate').value;
      const buy_platform = document.getElementById('buyPlatform').value;
      const goods_code = document.getElementById('goodsCode').value;
      const goods_desc = document.getElementById('goodsDesc').value;
      const status = document.getElementById('status').value || 'è¿è¾“ä¸­';

      const quantity = parseInt(document.getElementById('quantity').value, 10) || 0;
      const cost_price = parseFloat(document.getElementById('costPrice').value) || 0;

      const sell_date = document.getElementById('sellDate').value || null;
      const sellPriceInput = document.getElementById('sellPrice').value;
      const sell_price = sellPriceInput === '' ? null : (parseFloat(sellPriceInput) || null);

      const remark = document.getElementById('remark').value;

      if (!buy_date || !buy_platform || !quantity || !cost_price) {
        alert('è¯·å¡«å†™å¿…è¦ä¿¡æ¯ï¼šè´­ä¹°æ—¥æœŸã€å¹³å°ã€ä»¶æ•°ã€æˆæœ¬ä»·\nå”®å‡ºä»·å¯ç¨åæ·»åŠ ');
        return;
      }

      const payload = {
        user_id: user.id,
        buy_date,
        buy_platform,
        goods_code,
        goods_desc,
        status,
        quantity,
        cost_price: Number(cost_price.toFixed(2)),
        sell_date,
        sell_price: sell_price === null ? null : Number(sell_price.toFixed(2)),
        remark
      };

      const { error } = await supabase.from('purchases').insert(payload);
      if (error) return alert(error.message);

      document.getElementById('buyDate').valueAsDate = new Date();
      document.getElementById('buyPlatform').value = '';
      document.getElementById('goodsCode').value = '';
      document.getElementById('goodsDesc').value = '';
      document.getElementById('status').value = 'è¿è¾“ä¸­';
      document.getElementById('quantity').value = 1;
      document.getElementById('costPrice').value = '';
      document.getElementById('sellDate').valueAsDate = new Date();
      document.getElementById('sellPrice').value = '';
      document.getElementById('remark').value = '';

      showMsg('âœ“ äº‘ç«¯è®°å½•å·²æ·»åŠ ');
      await refreshRecords();
    };

    window.editRecord = function (rowId) {
      const record = records.find(r => r.id === rowId);
      if (!record) return;

      editingRowId = rowId;
      document.getElementById('editBuyDate').value = record.buy_date || '';
      document.getElementById('editBuyPlatform').value = record.buy_platform || 'æ·˜å®';
      document.getElementById('editGoodsCode').value = record.goods_code || '';
      document.getElementById('editGoodsDesc').value = record.goods_desc || '';
      document.getElementById('editStatus').value = record.status || 'è¿è¾“ä¸­';
      document.getElementById('editQuantity').value = record.quantity || 1;
      document.getElementById('editCostPrice').value = record.cost_price ?? 0;
      document.getElementById('editSellDate').value = record.sell_date || '';
      document.getElementById('editSellPrice').value = record.sell_price ?? '';
      document.getElementById('editRemark').value = record.remark || '';
      document.getElementById('editModal').classList.add('active');
    };

    window.closeEditModal = function () {
      document.getElementById('editModal').classList.remove('active');
      editingRowId = null;
    };

    window.saveRecord = async function () {
      if (editingRowId === null) return;

      const quantity = parseInt(document.getElementById('editQuantity').value, 10) || 0;
      const cost_price = parseFloat(document.getElementById('editCostPrice').value) || 0;
      if (!quantity || !cost_price) return alert('è¯·å¡«å†™ä»¶æ•°å’Œæˆæœ¬ä»·');

      const sellPriceInput = document.getElementById('editSellPrice').value;
      const sell_price = sellPriceInput === '' ? null : (parseFloat(sellPriceInput) || null);

      const updatePayload = {
        buy_date: document.getElementById('editBuyDate').value,
        buy_platform: document.getElementById('editBuyPlatform').value,
        goods_code: document.getElementById('editGoodsCode').value,
        goods_desc: document.getElementById('editGoodsDesc').value,
        status: document.getElementById('editStatus').value || 'è¿è¾“ä¸­',
        quantity,
        cost_price: Number(cost_price.toFixed(2)),
        sell_date: document.getElementById('editSellDate').value || null,
        sell_price: sell_price === null ? null : Number(sell_price.toFixed(2)),
        remark: document.getElementById('editRemark').value
      };

      const { error } = await supabase.from('purchases').update(updatePayload).eq('id', editingRowId);
      if (error) return alert(error.message);

      window.closeEditModal();
      showMsg('âœ“ äº‘ç«¯è®°å½•å·²æ›´æ–°');
      await refreshRecords();
    };

    window.deleteRecord = async function (rowId) {
      if (!confirm('ç¡®è®¤åˆ é™¤æ­¤è®°å½•ï¼Ÿ')) return;
      const { error } = await supabase.from('purchases').delete().eq('id', rowId);
      if (error) return alert(error.message);
      showMsg('âœ“ äº‘ç«¯è®°å½•å·²åˆ é™¤');
      await refreshRecords();
    };

    // ---------- ç­›é€‰ ----------
    window.applyFilters = function () {
      const status = document.getElementById('filterStatus').value;
      const platform = document.getElementById('filterPlatform').value;
      const sold = document.getElementById('filterSold').value;
      const keyword = document.getElementById('filterKeyword').value.trim().toLowerCase();

      filteredRecords = records.filter(r => {
        if (status !== 'å…¨éƒ¨' && (r.status || 'è¿è¾“ä¸­') !== status) return false;
        if (platform !== 'å…¨éƒ¨' && (r.buy_platform || '') !== platform) return false;

        const hasSell = !(r.sell_price === null || r.sell_price === undefined || r.sell_price === '');
        if (sold === 'å·²å”®å‡º' && !hasSell) return false;
        if (sold === 'æœªå”®å‡º' && hasSell) return false;

        if (keyword) {
          const hay = `${r.goods_code || ''} ${r.goods_desc || ''} ${r.remark || ''}`.toLowerCase();
          if (!hay.includes(keyword)) return false;
        }
        return true;
      });

      renderTable();
    };

    window.resetFilters = function () {
      document.getElementById('filterStatus').value = 'å…¨éƒ¨';
      document.getElementById('filterPlatform').value = 'å…¨éƒ¨';
      document.getElementById('filterSold').value = 'å…¨éƒ¨';
      document.getElementById('filterKeyword').value = '';
      applyFilters();
    };

    // ---------- çŠ¶æ€ç»Ÿè®¡ ----------
    function renderStatusStats() {
      const container = document.getElementById('statusStats');
      if (!container) return;

      const order = ['è¿è¾“ä¸­', 'åœ¨ä»“åº“', 'é—ªç”µä»“', 'å·²å‡ºå”®', 'å·²æ‰“æ¬¾'];

      const counts = (filteredRecords || []).reduce((acc, r) => {
        const s = (r.status || 'è¿è¾“ä¸­').trim();
        const q = Number(r.quantity || 0);
        acc[s] = (acc[s] || 0) + (Number.isFinite(q) ? q : 0);
        return acc;
      }, {});

      container.innerHTML = order.map(s => {
        const n = counts[s] || 0;
        return `
          <div style="border:1px solid #eee; border-radius:10px; padding:10px 12px; background:#fafafa;">
            <div style="font-size:12px; color:#666; margin-bottom:6px;">${escapeHtml(s)}</div>
            <div style="font-size:20px; font-weight:800; color:#333;">${n}</div>
          </div>
        `;
      }).join('');
    }

    // ---------- ç»Ÿè®¡ ----------
    function updateStats() {
      const rows = filteredRecords || [];

      document.getElementById('filteredCount').textContent = rows.length;
      document.getElementById('totalCount').textContent = rows.length;

      let totalQty = 0;
      let totalCost = 0;
      let totalRevenue = 0;
      let totalProfit = 0;
      let profitRateSum = 0;
      let profitRateCount = 0;

      rows.forEach(r => {
        const q = Number(r.quantity || 0);
        totalQty += Number.isFinite(q) ? q : 0;

        const d = calcDerived(r);
        totalCost += d.totalCost || 0;
        if (d.totalSell !== null) totalRevenue += d.totalSell;
        if (d.profit !== null) totalProfit += d.profit;
        if (d.profitRate !== null) { profitRateSum += d.profitRate; profitRateCount++; }
      });

      document.getElementById('totalQuantity').textContent = totalQty;
      document.getElementById('totalCost').textContent = `Â¥${totalCost.toFixed(2)}`;
      document.getElementById('totalRevenue').textContent = `Â¥${totalRevenue.toFixed(2)}`;
      document.getElementById('totalProfit').textContent = `Â¥${totalProfit.toFixed(2)}`;
      document.getElementById('avgProfitRate').textContent =
        `${profitRateCount ? (profitRateSum / profitRateCount).toFixed(2) : '0.00'}%`;

      renderStatusStats();
    }

    // ---------- è¡¨æ ¼æ¸²æŸ“ ----------
    function renderTable() {
      const tbody = document.getElementById('tableBody');
      const rows = filteredRecords || [];

      if (rows.length === 0) {
        tbody.innerHTML = `<tr class="empty-state"><td colspan="15">æš‚æ— æ•°æ®ï¼ˆå¯èƒ½è¢«ç­›é€‰æ¡ä»¶è¿‡æ»¤ï¼‰</td></tr>`;
        updateStats();
        return;
      }

      tbody.innerHTML = rows.map((r, idx) => {
        const d = calcDerived(r);

        const totalSellText = d.totalSell === null ? '' : `Â¥${d.totalSell.toFixed(2)}`;
        const profitText = d.profit === null ? '' : `Â¥${d.profit.toFixed(2)}`;
        const profitRateText = d.profitRate === null ? '' : `${d.profitRate.toFixed(2)}%`;

        const profitClass = (d.profit ?? 0) >= 0 ? 'profit-positive' : 'profit-negative';

        return `
          <tr>
            <td>${idx + 1}</td>
            <td>${escapeHtml(r.buy_date || '')}</td>
            <td>${escapeHtml(r.buy_platform || '')}</td>
            <td>${escapeHtml(r.goods_code || '')}</td>
            <td>${escapeHtml(r.goods_desc || '')}</td>
            <td>${statusBadge(r.status)}</td>
            <td>${Number(r.quantity || 0)}</td>
            <td>Â¥${Number(r.cost_price || 0).toFixed(2)}</td>
            <td>Â¥${(d.totalCost || 0).toFixed(2)}</td>
            <td>${escapeHtml(r.sell_date || '')}</td>
            <td>${(r.sell_price === null || r.sell_price === undefined) ? '' : `Â¥${Number(r.sell_price).toFixed(2)}`}</td>
            <td>${totalSellText}</td>
            <td class="${profitClass}">${profitText}</td>
            <td>${profitRateText}</td>
            <td>
              <button class="btn btn-secondary" style="padding:8px 12px; width:auto; font-size:12px;" onclick="editRecord(${r.id})">ç¼–è¾‘</button>
              <button class="btn btn-danger" onclick="deleteRecord(${r.id})">åˆ é™¤</button>
            </td>
          </tr>
        `;
      }).join('');

      updateStats();
    }

    // ---------- å¯¼å…¥ï¼ˆCSV/TSVï¼‰è¾…åŠ© ----------
    function readFileAsText(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(String(reader.result || ''));
        reader.onerror = () => reject(reader.error || new Error('è¯»å–æ–‡ä»¶å¤±è´¥'));
        reader.readAsText(file, 'utf-8'); // readAsText [web:357]
      });
    }

    function parseDelimitedTable(text) {
      const cleaned = String(text || '').replace(/^\uFEFF/, '').trim();
      if (!cleaned) return [];
      const delimiter = cleaned.includes('\t') ? '\t' : ',';

      const lines = cleaned.split(/\r?\n/);
      const rows = [];
      for (const line of lines) {
        if (line.trim() === '') continue;
        rows.push(parseLine(line, delimiter));
      }
      return rows;
    }

    function parseLine(line, delimiter) {
      const out = [];
      let cur = '';
      let inQuotes = false;

      for (let i = 0; i < line.length; i++) {
        const ch = line[i];
        if (ch === '"') {
          if (inQuotes && line[i + 1] === '"') { cur += '"'; i++; }
          else { inQuotes = !inQuotes; }
          continue;
        }
        if (!inQuotes && ch === delimiter) {
          out.push(cur);
          cur = '';
          continue;
        }
        cur += ch;
      }
      out.push(cur);
      return out.map(v => (v ?? '').trim());
    }

    function indexColumns(headerRow) {
      const map = {};
      for (let i = 0; i < headerRow.length; i++) {
        const key = String(headerRow[i] ?? '').trim();
        if (key) map[key] = i;
      }
      return map;
    }

    function getCell(row, colMap, name) {
      const idx = colMap[name];
      if (idx === undefined) return '';
      return String(row[idx] ?? '').trim();
    }

    function normalizeDate(s) {
      const v = String(s).trim();
      if (!v) return null;
      return v.replace(/[./]/g, '-');
    }

    // ---------- å®‰å…¨è½¬ä¹‰ ----------
    function escapeHtml(s) {
      return String(s ?? '')
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#39;');
    }

    // é¡µé¢é¦–æ¬¡ï¼šä¿æŒâ€œæœªç™»å½•â€æ—¶ä¹Ÿèƒ½æ­£å¸¸æ¸²æŸ“ç©ºè¡¨
    filteredRecords = [];
    renderTable();
  </script>
</body>
</html>
