<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>è´­é”€è®°è´¦å·¥å…·ï¼ˆäº‘ç«¯ Supabaseï¼‰</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    .container { max-width: 1200px; margin: 0 auto; }
    .header { text-align: center; color: white; margin-bottom: 18px; }
    .header h1 { font-size: 30px; margin-bottom: 8px; text-shadow: 0 2px 4px rgba(0,0,0,0.2); }
    .header p { font-size: 13px; opacity: 0.92; }

    .auth-bar {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 10px;
      align-items: center;
      margin-bottom: 18px;
    }
    @media (max-width: 768px) { .auth-bar { grid-template-columns: 1fr; } }

    .auth-info {
      background: rgba(255,255,255,0.12);
      border: 1px solid rgba(255,255,255,0.25);
      color: white;
      border-radius: 10px;
      padding: 12px 14px;
      font-size: 13px;
      line-height: 1.5;
    }
    .auth-actions { display: flex; gap: 10px; flex-wrap: wrap; }
    .auth-actions .btn { width: auto; }

    .main-content { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
    @media (max-width: 1024px) { .main-content { grid-template-columns: 1fr; } }

    .card { background: white; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.1); padding: 25px; }
    .card h2 { font-size: 18px; color: #333; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #667eea; }

    .form-group { margin-bottom: 15px; }
    label { display: block; font-size: 13px; font-weight: 600; color: #555; margin-bottom: 6px; }

    input, select, textarea {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      font-family: inherit;
      transition: all 0.3s;
    }
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .btn {
      padding: 11px 20px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      width: 100%;
    }
    .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; margin-top: 10px; }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3); }
    .btn-secondary { background: #f0f0f0; color: #333; border: 1px solid #ddd; }
    .btn-secondary:hover { background: #e8e8e8; }
    .btn-danger { background: #ff6b6b; color: white; padding: 8px 12px; width: auto; font-size: 12px; }
    .btn-danger:hover { background: #ff5252; }
    .btn-white { background: white; color: #333; border: 1px solid rgba(255,255,255,0.55); }
    .btn-white:hover { background: #f3f3f3; }

    .btn-group { display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap; }
    .btn-group .btn { flex: 1; min-width: 180px; }

    table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 13px; }
    thead { background: #f8f9fa; }
    th { padding: 12px; text-align: left; font-weight: 600; color: #333; border-bottom: 2px solid #ddd; }
    td { padding: 12px; border-bottom: 1px solid #eee; }
    tr:hover { background: #f9f9f9; }

    .profit-positive { color: #22c55e; font-weight: 600; }
    .profit-negative { color: #ff6b6b; font-weight: 600; }
    .empty-state { text-align: center; color: #999; padding: 30px; }
    .table-scroll { overflow-x: auto; }

    .success-message { background: #d4edda; color: #155724; padding: 12px 15px; border-radius: 6px; margin-bottom: 15px; display: none; }
    .success-message.show { display: block; }

    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
    .modal.active { display: flex; }
    .modal-content { background: white; border-radius: 12px; padding: 30px; max-width: 520px; width: 90%; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3); position: relative; }
    .modal-header { font-size: 20px; font-weight: 700; margin-bottom: 20px; color: #333; }
    .modal-close { position: absolute; top: 10px; right: 12px; background: none; border: none; font-size: 28px; cursor: pointer; color: #999; }
    .modal-body { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
    @media (max-width: 600px) { .modal-body { grid-template-columns: 1fr; } }
    .modal-actions { display: flex; gap: 10px; margin-top: 20px; }
    .modal-actions button { flex: 1; }

    .hidden { display: none !important; }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ“Š è´­é”€è®°è´¦å·¥å…·</h1>
      <p>äº‘ç«¯ç‰ˆï¼ˆSupabaseï¼‰- å¤šè®¾å¤‡åŒæ­¥ / æ¯è´¦å·ç‹¬ç«‹</p>
    </div>

    <div class="auth-bar">
      <div class="auth-info" id="authInfo">æœªç™»å½•ï¼šè¯·å…ˆç™»å½•/æ³¨å†Œ</div>
      <div class="auth-actions">
        <button class="btn btn-white" onclick="openAuthModal()">ç™»å½• / æ³¨å†Œ</button>
        <button class="btn btn-white" onclick="signOut()">é€€å‡ºç™»å½•</button>
      </div>
    </div>

    <div class="main-content hidden" id="appRoot">
      <!-- æ·»åŠ è®°å½• -->
      <div class="card">
        <h2>â• æ·»åŠ æ–°è®°å½•</h2>
        <div class="success-message" id="successMsg">âœ“ æ“ä½œæˆåŠŸ</div>

        <div class="form-group">
          <label>è´­ä¹°æ—¥æœŸ</label>
          <input type="date" id="buyDate" />
        </div>

        <div class="form-group">
          <label>è´­ä¹°å¹³å°</label>
          <select id="buyPlatform">
            <option value="">-- é€‰æ‹©å¹³å° --</option>
            <option value="æ·˜å®">æ·˜å®</option>
            <option value="äº¬ä¸œ">äº¬ä¸œ</option>
            <option value="æ‹¼å¤šå¤š">æ‹¼å¤šå¤š</option>
            <option value="å¾—ç‰©">å¾—ç‰©</option>
            <option value="æŠ–éŸ³å°åº—">æŠ–éŸ³å°åº—</option>
            <option value="å°çº¢ä¹¦">å°çº¢ä¹¦</option>
            <option value="äºšé©¬é€Š">äºšé©¬é€Š</option>
            <option value="eBay">eBay</option>
            <option value="å…¶ä»–">å…¶ä»–</option>
          </select>
        </div>

        <div class="form-group">
          <label>è´§å·</label>
          <input type="text" id="goodsCode" placeholder="å¦‚ï¼šDZ2024001" />
        </div>

        <div class="form-group">
          <label>å•†å“æè¿°</label>
          <textarea id="goodsDesc" placeholder="å•†å“åç§°ã€å‹å·ç­‰ä¿¡æ¯" rows="2"></textarea>
        </div>

        <div class="form-group">
          <label>ä»¶æ•°</label>
          <input type="number" id="quantity" value="1" min="1" step="1" />
        </div>

        <div class="form-group">
          <label>å•ä»¶æˆæœ¬ä»· (Â¥)</label>
          <input type="number" id="costPrice" placeholder="0.00" step="0.01" min="0" />
        </div>

        <div class="form-group">
          <label>å‡ºå”®æ—¥æœŸ <span style="color: #999; font-weight: normal;">(å¯é€‰)</span></label>
          <input type="date" id="sellDate" />
        </div>

        <div class="form-group">
          <label>å•ä»¶å”®å‡ºä»· <span style="color: #999; font-weight: normal;">(å¯é€‰)</span></label>
          <input type="number" id="sellPrice" placeholder="å¾…å¡«å†™" step="0.01" min="0" />
        </div>

        <div class="form-group">
          <label>å¤‡æ³¨</label>
          <input type="text" id="remark" placeholder="å…¶ä»–è¯´æ˜" />
        </div>

        <button class="btn btn-primary" onclick="addRecord()">æ·»åŠ è®°å½•</button>
      </div>

      <!-- æ•°æ®ç»Ÿè®¡ -->
      <div class="card">
        <h2>ğŸ“ˆ æ•°æ®ç»Ÿè®¡</h2>
        <div style="padding: 20px 0;">
          <div style="margin-bottom: 20px;">
            <div style="font-size: 12px; color: #666; margin-bottom: 5px;">æ€»äº¤æ˜“ç¬”æ•°</div>
            <div style="font-size: 28px; font-weight: 700; color: #667eea;" id="totalCount">0</div>
          </div>

          <div style="margin-bottom: 20px;">
            <div style="font-size: 12px; color: #666; margin-bottom: 5px;">æ€»ä»¶æ•°</div>
            <div style="font-size: 28px; font-weight: 700; color: #667eea;" id="totalQuantity">0</div>
          </div>

          <div style="margin-bottom: 20px;">
            <div style="font-size: 12px; color: #666; margin-bottom: 5px;">æ€»æˆæœ¬</div>
            <div style="font-size: 28px; font-weight: 700; color: #333;" id="totalCost">Â¥0.00</div>
          </div>

          <div style="margin-bottom: 20px;">
            <div style="font-size: 12px; color: #666; margin-bottom: 5px;">æ€»æ”¶ç›Š</div>
            <div style="font-size: 28px; font-weight: 700; color: #22c55e;" id="totalRevenue">Â¥0.00</div>
          </div>

          <div>
            <div style="font-size: 12px; color: #666; margin-bottom: 5px;">æ€»åˆ©æ¶¦ / å¹³å‡åˆ©æ¶¦ç‡</div>
            <div style="font-size: 20px; font-weight: 700; color: #764ba2;">
              <span id="totalProfit">Â¥0.00</span>
              <span style="margin-left: 8px;" id="avgProfitRate">0%</span>
            </div>
          </div>
        </div>

        <div class="btn-group">
          <button class="btn btn-secondary" onclick="exportData()">ğŸ“¥ å¯¼å‡ºæ•°æ®</button>
          <button class="btn btn-secondary" onclick="triggerImport()">ğŸ“¤ å¯¼å…¥æ•°æ®</button>
          <button class="btn btn-secondary" onclick="refreshRecords()">ğŸ”„ åˆ·æ–°äº‘ç«¯æ•°æ®</button>
        </div>

        <input id="importFile" type="file" accept=".csv,.tsv,text/csv,text/tab-separated-values" class="hidden" />
      </div>

      <!-- è®°å½•åˆ—è¡¨ -->
      <div class="card" style="grid-column: 1 / -1;">
        <h2>ğŸ“‹ äº¤æ˜“è®°å½•</h2>
        <div class="table-scroll">
          <table id="recordsTable">
            <thead>
              <tr>
                <th>åºå·</th>
                <th>è´­ä¹°æ—¥æœŸ</th>
                <th>å¹³å°</th>
                <th>è´§å·</th>
                <th>å•†å“æè¿°</th>
                <th>ä»¶æ•°</th>
                <th>å•ä»¶æˆæœ¬</th>
                <th>æ€»æˆæœ¬</th>
                <th>å‡ºå”®æ—¥æœŸ</th>
                <th>å•ä»¶å”®å‡ºä»·</th>
                <th>æ€»å”®å‡ºä»·</th>
                <th>åˆ©æ¶¦</th>
                <th>åˆ©æ¶¦ç‡</th>
                <th style="width: 120px;">æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="tableBody">
              <tr class="empty-state">
                <td colspan="14">æš‚æ— æ•°æ®ï¼Œæ·»åŠ ç¬¬ä¸€æ¡è®°å½•å§ ğŸ‘†</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ç™»å½•/æ³¨å†Œæ¨¡æ€æ¡† -->
    <div class="modal" id="authModal">
      <div class="modal-content">
        <button class="modal-close" onclick="closeAuthModal()">Ã—</button>
        <div class="modal-header">ç™»å½• / æ³¨å†Œï¼ˆSupabaseï¼‰</div>

        <div class="form-group">
          <label>é‚®ç®±</label>
          <input type="email" id="authEmail" placeholder="you@example.com" />
        </div>

        <div class="form-group">
          <label>å¯†ç </label>
          <input type="password" id="authPassword" placeholder="è‡³å°‘ 6 ä½" />
        </div>

        <div class="modal-actions">
          <button class="btn btn-secondary" onclick="signIn()">ç™»å½•</button>
          <button class="btn btn-primary" onclick="signUp()">æ³¨å†Œ</button>
        </div>

        <div style="margin-top: 12px; font-size: 12px; color: #666; line-height: 1.6;">
          å¦‚æœä½ åœ¨ Supabase å¼€å¯äº†é‚®ç®±éªŒè¯ï¼Œæ³¨å†Œåéœ€è¦å…ˆå»é‚®ç®±ç¡®è®¤é“¾æ¥æ‰èƒ½ç™»å½•ã€‚
        </div>
      </div>
    </div>

    <!-- ç¼–è¾‘è®°å½•æ¨¡æ€æ¡† -->
    <div class="modal" id="editModal">
      <div class="modal-content">
        <button class="modal-close" onclick="closeEditModal()">Ã—</button>
        <div class="modal-header">ç¼–è¾‘è®°å½•</div>

        <div class="modal-body">
          <div class="form-group">
            <label>è´­ä¹°æ—¥æœŸ</label>
            <input type="date" id="editBuyDate" />
          </div>
          <div class="form-group">
            <label>è´­ä¹°å¹³å°</label>
            <select id="editBuyPlatform">
              <option value="æ·˜å®">æ·˜å®</option>
              <option value="äº¬ä¸œ">äº¬ä¸œ</option>
              <option value="æ‹¼å¤šå¤š">æ‹¼å¤šå¤š</option>
              <option value="å¾—ç‰©">å¾—ç‰©</option>
              <option value="æŠ–éŸ³å°åº—">æŠ–éŸ³å°åº—</option>
              <option value="å°çº¢ä¹¦">å°çº¢ä¹¦</option>
              <option value="äºšé©¬é€Š">äºšé©¬é€Š</option>
              <option value="eBay">eBay</option>
              <option value="å…¶ä»–">å…¶ä»–</option>
            </select>
          </div>

          <div class="form-group">
            <label>è´§å·</label>
            <input type="text" id="editGoodsCode" />
          </div>
          <div class="form-group">
            <label>å•†å“æè¿°</label>
            <input type="text" id="editGoodsDesc" />
          </div>

          <div class="form-group">
            <label>ä»¶æ•°</label>
            <input type="number" id="editQuantity" min="1" step="1" />
          </div>
          <div class="form-group">
            <label>å•ä»¶æˆæœ¬ä»· (Â¥)</label>
            <input type="number" id="editCostPrice" step="0.01" min="0" />
          </div>

          <div class="form-group">
            <label>å‡ºå”®æ—¥æœŸ</label>
            <input type="date" id="editSellDate" />
          </div>
          <div class="form-group">
            <label>å•ä»¶å”®å‡ºä»· (Â¥)</label>
            <input type="number" id="editSellPrice" step="0.01" min="0" />
          </div>

          <div class="form-group" style="grid-column: 1 / -1;">
            <label>å¤‡æ³¨</label>
            <input type="text" id="editRemark" />
          </div>
        </div>

        <div class="modal-actions">
          <button class="btn btn-secondary" onclick="closeEditModal()">å–æ¶ˆ</button>
          <button class="btn btn-primary" onclick="saveRecord()">ä¿å­˜ä¿®æ”¹</button>
        </div>
      </div>
    </div>

  </div>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    // === ä½ çš„ Supabase ä¿¡æ¯ï¼ˆå¦‚æ¢é¡¹ç›®ï¼Œæ”¹è¿™é‡Œï¼‰ ===
    const SUPABASE_URL = "https://tpvodhwikbhigdxcthsk.supabase.co";
    const SUPABASE_KEY = "sb_publishable_kiSkcXCRrrfdbsOAfjuNnw_pSHDoTNa";
    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY); // åˆå§‹åŒ– [web:208]

    // çŠ¶æ€
    let records = [];
    let editingRowId = null;

    // åˆå§‹åŒ–æ—¥æœŸ
    document.getElementById('buyDate').valueAsDate = new Date();
    document.getElementById('sellDate').valueAsDate = new Date();

    // ---------- UI ----------
    function showMsg(text) {
      const msg = document.getElementById('successMsg');
      msg.textContent = text;
      msg.classList.add('show');
      setTimeout(() => msg.classList.remove('show'), 2200);
    }

    window.openAuthModal = () => document.getElementById('authModal').classList.add('active');
    window.closeAuthModal = () => document.getElementById('authModal').classList.remove('active');

    function setLoggedInUI(user) {
      const info = document.getElementById('authInfo');
      const root = document.getElementById('appRoot');
      if (user) {
        info.textContent = `å·²ç™»å½•ï¼š${user.email}\nï¼ˆæç¤ºï¼šæ•°æ®å­˜äº‘ç«¯ï¼Œæ¢è®¾å¤‡ç™»å½•åŒè´¦å·å³å¯åŒæ­¥ï¼‰`;
        root.classList.remove('hidden');
      } else {
        info.textContent = 'æœªç™»å½•ï¼šè¯·å…ˆç™»å½•/æ³¨å†Œ';
        root.classList.add('hidden');
      }
    }

    // ---------- Auth ----------
    window.signUp = async function () {
      const email = document.getElementById('authEmail').value.trim();
      const password = document.getElementById('authPassword').value.trim();
      if (!email || !password) return alert('è¯·è¾“å…¥é‚®ç®±å’Œå¯†ç ');

      const { error } = await supabase.auth.signUp({ email, password });
      if (error) return alert(error.message);
      alert('æ³¨å†ŒæˆåŠŸã€‚è‹¥å¯ç”¨é‚®ç®±éªŒè¯ï¼Œè¯·å…ˆå»é‚®ç®±ç¡®è®¤åå†ç™»å½•ã€‚');
    };

    window.signIn = async function () {
      const email = document.getElementById('authEmail').value.trim();
      const password = document.getElementById('authPassword').value.trim();
      if (!email || !password) return alert('è¯·è¾“å…¥é‚®ç®±å’Œå¯†ç ');

      const { error } = await supabase.auth.signInWithPassword({ email, password });
      if (error) return alert(error.message);

      window.closeAuthModal();
      await refreshRecords();
    };

    window.signOut = async function () {
      await supabase.auth.signOut();
      records = [];
      renderTable();
      setLoggedInUI(null);
    };

    supabase.auth.onAuthStateChange(async (_event, session) => {
      setLoggedInUI(session?.user ?? null);
      if (session?.user) await refreshRecords();
    });

    const { data: { session } } = await supabase.auth.getSession();
    setLoggedInUI(session?.user ?? null);
    if (session?.user) await refreshRecords();

    // ---------- è®¡ç®— ----------
    function calcDerived(record) {
      const q = Number(record.quantity || 0);
      const cost = Number(record.cost_price || 0);
      const sell = record.sell_price === null || record.sell_price === undefined ? null : Number(record.sell_price);

      const totalCost = cost * q;
      const totalSell = sell === null || Number.isNaN(sell) ? null : (sell * q);
      const profit = totalSell === null ? null : (totalSell - totalCost);
      const profitRate = totalSell === null || totalCost <= 0 ? null : (profit / totalCost * 100);
      return { totalCost, totalSell, profit, profitRate };
    }

    // ---------- äº‘ç«¯è¯»å†™ ----------
    window.refreshRecords = async function () {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) return;

      const { data, error } = await supabase
        .from('purchases')
        .select('*')
        .order('created_at', { ascending: false });

      if (error) return alert(error.message);
      records = data || [];
      renderTable();
    };

    window.addRecord = async function () {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) return alert('è¯·å…ˆç™»å½•');

      const buy_date = document.getElementById('buyDate').value;
      const buy_platform = document.getElementById('buyPlatform').value;
      const goods_code = document.getElementById('goodsCode').value;
      const goods_desc = document.getElementById('goodsDesc').value;
      const quantity = parseInt(document.getElementById('quantity').value, 10) || 0;
      const cost_price = parseFloat(document.getElementById('costPrice').value) || 0;

      const sell_date = document.getElementById('sellDate').value || null;
      const sellPriceInput = document.getElementById('sellPrice').value;
      const sell_price = sellPriceInput === '' ? null : (parseFloat(sellPriceInput) || null);

      const remark = document.getElementById('remark').value;

      if (!buy_date || !buy_platform || !quantity || !cost_price) {
        alert('è¯·å¡«å†™å¿…è¦ä¿¡æ¯ï¼šè´­ä¹°æ—¥æœŸã€å¹³å°ã€ä»¶æ•°ã€æˆæœ¬ä»·\nå”®å‡ºä»·å¯ç¨åæ·»åŠ ');
        return;
      }

      const payload = {
        user_id: user.id,
        buy_date,
        buy_platform,
        goods_code,
        goods_desc,
        quantity,
        cost_price: Number(cost_price.toFixed(2)),
        sell_date,
        sell_price: sell_price === null ? null : Number(sell_price.toFixed(2)),
        remark
      };

      const { error } = await supabase.from('purchases').insert(payload); // æ‰¹é‡/å•æ¡ insert å‡å¯ [web:362]
      if (error) return alert(error.message);

      document.getElementById('buyDate').valueAsDate = new Date();
      document.getElementById('buyPlatform').value = '';
      document.getElementById('goodsCode').value = '';
      document.getElementById('goodsDesc').value = '';
      document.getElementById('quantity').value = 1;
      document.getElementById('costPrice').value = '';
      document.getElementById('sellDate').valueAsDate = new Date();
      document.getElementById('sellPrice').value = '';
      document.getElementById('remark').value = '';

      showMsg('âœ“ äº‘ç«¯è®°å½•å·²æ·»åŠ ');
      await refreshRecords();
    };

    window.editRecord = function (rowId) {
      const record = records.find(r => r.id === rowId);
      if (!record) return;

      editingRowId = rowId;
      document.getElementById('editBuyDate').value = record.buy_date || '';
      document.getElementById('editBuyPlatform').value = record.buy_platform || 'æ·˜å®';
      document.getElementById('editGoodsCode').value = record.goods_code || '';
      document.getElementById('editGoodsDesc').value = record.goods_desc || '';
      document.getElementById('editQuantity').value = record.quantity || 1;
      document.getElementById('editCostPrice').value = record.cost_price ?? 0;
      document.getElementById('editSellDate').value = record.sell_date || '';
      document.getElementById('editSellPrice').value = record.sell_price ?? '';
      document.getElementById('editRemark').value = record.remark || '';
      document.getElementById('editModal').classList.add('active');
    };

    window.closeEditModal = function () {
      document.getElementById('editModal').classList.remove('active');
      editingRowId = null;
    };

    window.saveRecord = async function () {
      if (editingRowId === null) return;

      const quantity = parseInt(document.getElementById('editQuantity').value, 10) || 0;
      const cost_price = parseFloat(document.getElementById('editCostPrice').value) || 0;
      if (!quantity || !cost_price) return alert('è¯·å¡«å†™ä»¶æ•°å’Œæˆæœ¬ä»·');

      const sellPriceInput = document.getElementById('editSellPrice').value;
      const sell_price = sellPriceInput === '' ? null : (parseFloat(sellPriceInput) || null);

      const updatePayload = {
        buy_date: document.getElementById('editBuyDate').value,
        buy_platform: document.getElementById('editBuyPlatform').value,
        goods_code: document.getElementById('editGoodsCode').value,
        goods_desc: document.getElementById('editGoodsDesc').value,
        quantity,
        cost_price: Number(cost_price.toFixed(2)),
        sell_date: document.getElementById('editSellDate').value || null,
        sell_price: sell_price === null ? null : Number(sell_price.toFixed(2)),
        remark: document.getElementById('editRemark').value
      };

      const { error } = await supabase.from('purchases').update(updatePayload).eq('id', editingRowId);
      if (error) return alert(error.message);

      window.closeEditModal();
      showMsg('âœ“ äº‘ç«¯è®°å½•å·²æ›´æ–°');
      await refreshRecords();
    };

    window.deleteRecord = async function (rowId) {
      if (!confirm('ç¡®è®¤åˆ é™¤æ­¤è®°å½•ï¼Ÿ')) return;
      const { error } = await supabase.from('purchases').delete().eq('id', rowId);
      if (error) return alert(error.message);
      showMsg('âœ“ äº‘ç«¯è®°å½•å·²åˆ é™¤');
      await refreshRecords();
    };

    // ---------- å¯¼å‡º ----------
    window.exportData = function () {
      if (!records || records.length === 0) return alert('æš‚æ— æ•°æ®å¯å¯¼å‡º');

      let csv = 'åºå·,è´­ä¹°æ—¥æœŸ,è´­ä¹°å¹³å°,è´§å·,å•†å“æè¿°,ä»¶æ•°,å•ä»¶æˆæœ¬,æ€»æˆæœ¬,å‡ºå”®æ—¥æœŸ,å•ä»¶å”®å‡ºä»·,æ€»å”®å‡ºä»·,åˆ©æ¶¦,åˆ©æ¶¦ç‡,å¤‡æ³¨\n';
      records.forEach((r, idx) => {
        const { totalCost, totalSell, profit, profitRate } = calcDerived(r);
        const sellDate = r.sell_date || '';
        const sellPrice = r.sell_price === null || r.sell_price === undefined ? '' : Number(r.sell_price).toFixed(2);

        const safeDesc = (r.goods_desc || '').replaceAll('"', '""');
        const safeRemark = (r.remark || '').replaceAll('"', '""');

        csv += `${idx + 1},"${r.buy_date || ''}","${r.buy_platform || ''}","${r.goods_code || ''}","${safeDesc}",${r.quantity || 0},${Number(r.cost_price || 0).toFixed(2)},${Number(totalCost || 0).toFixed(2)},"${sellDate}",${sellPrice},${totalSell === null ? '' : Number(totalSell).toFixed(2)},${profit === null ? '' : profit.toFixed(2)},${profitRate === null ? '' : profitRate.toFixed(2)}%,"${safeRemark}"\n`;
      });

      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `è´­é”€è®°è´¦_äº‘ç«¯_${new Date().toISOString().split('T')[0]}.csv`;
      link.click();
    };

    // ---------- å¯¼å…¥ï¼ˆCSV/TSVï¼‰ ----------
    const importInput = document.getElementById('importFile');

    window.triggerImport = function () {
      importInput.value = '';
      importInput.click();
    };

    importInput.addEventListener('change', async (e) => {
      const file = e.target.files?.[0];
      if (!file) return;

      const { data: { user } } = await supabase.auth.getUser();
      if (!user) return alert('è¯·å…ˆç™»å½•');

      const ok = confirm('ç¡®è®¤å¯¼å…¥ï¼Ÿå¯¼å…¥ä¼šæŠŠæ–‡ä»¶é‡Œçš„è®°å½•è¿½åŠ åˆ°äº‘ç«¯ï¼ˆä¸ä¼šè¦†ç›–å·²æœ‰æ•°æ®ï¼‰ã€‚\næ³¨æ„ï¼šé‡å¤å¯¼å…¥åŒä¸€ä¸ªæ–‡ä»¶ä¼šäº§ç”Ÿé‡å¤æ•°æ®ã€‚');
      if (!ok) return;

      try {
        const text = await readFileAsText(file); // FileReader è¯»å–æ–‡æœ¬ [web:357]
        const rows = parseDelimitedTable(text);
        if (rows.length < 2) return alert('æ–‡ä»¶å†…å®¹ä¸ºç©ºæˆ–æ ¼å¼ä¸æ­£ç¡®');

        const header = rows[0];
        const col = indexColumns(header);

        const required = ['è´­ä¹°æ—¥æœŸ', 'è´­ä¹°å¹³å°', 'ä»¶æ•°', 'å•ä»¶æˆæœ¬'];
        for (const k of required) {
          if (col[k] === undefined) return alert(`ç¼ºå°‘åˆ—ï¼š${k}`);
        }

        const payloads = [];
        for (let i = 1; i < rows.length; i++) {
          const r = rows[i];
          if (r.every(v => (v ?? '').trim() === '')) continue;

          const buy_date = getCell(r, col, 'è´­ä¹°æ—¥æœŸ');
          const buy_platform = getCell(r, col, 'è´­ä¹°å¹³å°');
          const goods_code = getCell(r, col, 'è´§å·');
          const goods_desc = getCell(r, col, 'å•†å“æè¿°');
          const quantityStr = getCell(r, col, 'ä»¶æ•°');
          const costStr = getCell(r, col, 'å•ä»¶æˆæœ¬');
          const sell_date = getCell(r, col, 'å‡ºå”®æ—¥æœŸ');
          const sellStr = getCell(r, col, 'å•ä»¶å”®å‡ºä»·');
          const remark = getCell(r, col, 'å¤‡æ³¨');

          const quantity = parseInt(quantityStr, 10);
          const cost_price = parseFloat(costStr);

          if (!buy_date || !buy_platform || !Number.isFinite(quantity) || quantity <= 0 || !Number.isFinite(cost_price) || cost_price <= 0) {
            continue; // è·³è¿‡ä¸å®Œæ•´è¡Œ
          }

          let sell_price = null;
          if (sellStr !== '') {
            const s = parseFloat(sellStr);
            sell_price = Number.isFinite(s) ? Number(s.toFixed(2)) : null;
          }

          payloads.push({
            user_id: user.id,
            buy_date: normalizeDate(buy_date),
            buy_platform: buy_platform.trim(),
            goods_code: (goods_code || '').trim(),
            goods_desc: (goods_desc || '').trim(),
            quantity,
            cost_price: Number(cost_price.toFixed(2)),
            sell_date: sell_date ? normalizeDate(sell_date) : null,
            sell_price,
            remark: (remark || '').trim()
          });
        }

        if (payloads.length === 0) return alert('æ²¡æœ‰å¯å¯¼å…¥çš„æœ‰æ•ˆæ•°æ®ï¼ˆå¯èƒ½æ—¥æœŸ/ä»¶æ•°/æˆæœ¬ä¸ºç©ºæˆ–æ ¼å¼ä¸å¯¹ï¼‰');

        const batchSize = 200;
        let inserted = 0;

        for (let start = 0; start < payloads.length; start += batchSize) {
          const batch = payloads.slice(start, start + batchSize);
          const { error } = await supabase.from('purchases').insert(batch); // æ‰¹é‡ insert [web:362]
          if (error) throw new Error(error.message);
          inserted += batch.length;
        }

        showMsg(`âœ“ å·²å¯¼å…¥ ${inserted} æ¡åˆ°äº‘ç«¯`);
        await refreshRecords();
      } catch (err) {
        alert('å¯¼å…¥å¤±è´¥ï¼š' + (err?.message || String(err)));
      }
    });

    function readFileAsText(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(String(reader.result || ''));
        reader.onerror = () => reject(reader.error || new Error('è¯»å–æ–‡ä»¶å¤±è´¥'));
        reader.readAsText(file, 'utf-8'); // readAsText [web:357]
      });
    }

    function parseDelimitedTable(text) {
      const cleaned = String(text || '').replace(/^\uFEFF/, '').trim();
      if (!cleaned) return [];
      const delimiter = cleaned.includes('\t') ? '\t' : ','; // å…¼å®¹ TSV/CSV

      const lines = cleaned.split(/\r?\n/);
      const rows = [];
      for (const line of lines) {
        if (line.trim() === '') continue;
        rows.push(parseLine(line, delimiter));
      }
      return rows;
    }

    function parseLine(line, delimiter) {
      const out = [];
      let cur = '';
      let inQuotes = false;

      for (let i = 0; i < line.length; i++) {
        const ch = line[i];
        if (ch === '"') {
          if (inQuotes && line[i + 1] === '"') { cur += '"'; i++; }
          else { inQuotes = !inQuotes; }
          continue;
        }
        if (!inQuotes && ch === delimiter) {
          out.push(cur);
          cur = '';
          continue;
        }
        cur += ch;
      }
      out.push(cur);
      return out.map(v => (v ?? '').trim());
    }

    function indexColumns(headerRow) {
      const map = {};
      for (let i = 0; i < headerRow.length; i++) {
        const key = String(headerRow[i] ?? '').trim();
        if (key) map[key] = i;
      }
      return map;
    }

    function getCell(row, colMap, name) {
      const idx = colMap[name];
      if (idx === undefined) return '';
      return String(row[idx] ?? '').trim();
    }

    function normalizeDate(s) {
      const v = String(s).trim();
      if (!v) return null;
      return v.replace(/[./]/g, '-');
    }

    // ---------- æ¸²æŸ“ ----------
    function renderTable() {
      const tbody = document.getElementById('tableBody');

      if (!records || records.length === 0) {
        tbody.innerHTML = '<tr class="empty-state"><td colspan="14">æš‚æ— æ•°æ®ï¼Œæ·»åŠ ç¬¬ä¸€æ¡è®°å½•å§ ğŸ‘†</td></tr>';
        updateStats();
        return;
      }

      tbody.innerHTML = records.map((r, index) => {
        const { totalCost, totalSell, profit, profitRate } = calcDerived(r);

        const profitClass = profit === null ? '' : (profit >= 0 ? 'profit-positive' : 'profit-negative');
        const profitDisplay = profit === null ? 'å¾…å®š' : `Â¥${profit.toFixed(2)}`;
        const profitRateDisplay = profitRate === null ? 'å¾…å®š' : `${profitRate.toFixed(2)}%`;

        const sellDateDisplay = r.sell_date ? r.sell_date : '-';
        const sellPriceDisplay = (r.sell_price === null || r.sell_price === undefined) ? '-' : `Â¥${Number(r.sell_price).toFixed(2)}`;

        return `
          <tr>
            <td>${index + 1}</td>
            <td>${r.buy_date || ''}</td>
            <td>${r.buy_platform || ''}</td>
            <td>${r.goods_code || ''}</td>
            <td>${r.goods_desc || ''}</td>
            <td>${r.quantity || 0}</td>
            <td>Â¥${Number(r.cost_price || 0).toFixed(2)}</td>
            <td>Â¥${Number(totalCost || 0).toFixed(2)}</td>
            <td>${sellDateDisplay}</td>
            <td>${sellPriceDisplay}</td>
            <td>${totalSell === null ? '-' : `Â¥${Number(totalSell).toFixed(2)}`}</td>
            <td class="${profitClass}">${profitDisplay}</td>
            <td class="${profitClass}">${profitRateDisplay}</td>
            <td style="display:flex; gap:5px;">
              <button class="btn btn-danger" style="flex:1; padding:6px 8px; font-size:11px;" onclick="editRecord(${r.id})">ç¼–è¾‘</button>
              <button class="btn btn-danger" style="flex:1; padding:6px 8px; font-size:11px; background:#ff6b6b;" onclick="deleteRecord(${r.id})">åˆ é™¤</button>
            </td>
          </tr>
        `;
      }).join('');

      updateStats();
    }

    function updateStats() {
      const totalCount = records.length;
      const totalQuantity = records.reduce((sum, r) => sum + Number(r.quantity || 0), 0);

      const totalCost = records.reduce((sum, r) => {
        const { totalCost } = calcDerived(r);
        return sum + Number(totalCost || 0);
      }, 0);

      const totalRevenue = records.reduce((sum, r) => {
        const { totalSell } = calcDerived(r);
        return sum + Number(totalSell || 0);
      }, 0);

      const totalProfit = totalRevenue - totalCost;
      const avgProfitRate = totalCost > 0 ? ((totalProfit / totalCost) * 100) : 0;

      document.getElementById('totalCount').textContent = totalCount;
      document.getElementById('totalQuantity').textContent = totalQuantity;
      document.getElementById('totalCost').textContent = 'Â¥' + totalCost.toFixed(2);
      document.getElementById('totalRevenue').textContent = 'Â¥' + totalRevenue.toFixed(2);
      document.getElementById('totalProfit').textContent = 'Â¥' + totalProfit.toFixed(2);
      document.getElementById('avgProfitRate').textContent = avgProfitRate.toFixed(2) + '%';
    }

    // åˆæ¬¡æ¸²æŸ“
    renderTable();
  </script>
</body>
</html>
