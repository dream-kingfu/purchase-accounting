<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è´­é”€è®°è´¦å·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .header p {
            font-size: 14px;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            padding: 25px;
        }

        .card h2 {
            font-size: 18px;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: #555;
            margin-bottom: 6px;
        }

        input, select, textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
            transition: all 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            padding: 11px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            margin-top: 10px;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #333;
            border: 1px solid #ddd;
        }

        .btn-secondary:hover {
            background: #e8e8e8;
        }

        .btn-danger {
            background: #ff6b6b;
            color: white;
            padding: 8px 12px;
            width: auto;
            font-size: 12px;
        }

        .btn-danger:hover {
            background: #ff5252;
        }

        .modal-body {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        @media (max-width: 600px) {
            .modal-body {
                grid-template-columns: 1fr;
            }
        }

        .form-group-modal {
            margin-bottom: 0;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-actions button {
            flex: 1;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .btn-group .btn {
            flex: 1;
        }

        .records-section {
            grid-column: 1 / -1;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 13px;
        }

        thead {
            background: #f8f9fa;
        }

        th {
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #333;
            border-bottom: 2px solid #ddd;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #eee;
        }

        tr:hover {
            background: #f9f9f9;
        }

        .profit-positive {
            color: #22c55e;
            font-weight: 600;
        }

        .profit-negative {
            color: #ff6b6b;
            font-weight: 600;
        }

        .empty-state {
            text-align: center;
            color: #999;
            padding: 30px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .modal-header {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 20px;
            color: #333;
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #999;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 12px 15px;
            border-radius: 6px;
            margin-bottom: 15px;
            display: none;
        }

        .success-message.show {
            display: block;
        }

        .table-scroll {
            overflow-x: auto;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 24px;
            }

            table {
                font-size: 12px;
            }

            th, td {
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“Š è´­é”€è®°è´¦å·¥å…·</h1>
            <p>ä¸“ä¸šçš„å•†å“è¿›é”€è®°å½•ç®¡ç†ç³»ç»Ÿ</p>
        </div>

        <div class="main-content">
            <!-- æ·»åŠ è®°å½•å¡ç‰‡ -->
            <div class="card">
                <h2>â• æ·»åŠ æ–°è®°å½•</h2>
                <div class="success-message" id="successMsg">âœ“ è®°å½•å·²æ·»åŠ </div>
                
                <div class="form-group">
                    <label>è´­ä¹°æ—¥æœŸ</label>
                    <input type="date" id="buyDate">
                </div>

                <div class="form-group">
                    <label>è´­ä¹°å¹³å°</label>
                    <select id="buyPlatform">
                        <option value="">-- é€‰æ‹©å¹³å° --</option>
                        <option value="æ·˜å®">æ·˜å®</option>
                        <option value="äº¬ä¸œ">äº¬ä¸œ</option>
                        <option value="æ‹¼å¤šå¤š">æ‹¼å¤šå¤š</option>
                        <option value="å¾—ç‰©">å¾—ç‰©</option>
                        <option value="æŠ–éŸ³å°åº—">æŠ–éŸ³å°åº—</option>
                        <option value="å°çº¢ä¹¦">å°çº¢ä¹¦</option>
                        <option value="äºšé©¬é€Š">äºšé©¬é€Š</option>
                        <option value="eBay">eBay</option>
                        <option value="å…¶ä»–">å…¶ä»–</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>è´§å·</label>
                    <input type="text" id="goodsCode" placeholder="å¦‚ï¼šDZ2024001">
                </div>

                <div class="form-group">
                    <label>å•†å“æè¿°</label>
                    <textarea id="goodsDesc" placeholder="å•†å“åç§°ã€å‹å·ç­‰ä¿¡æ¯" rows="2"></textarea>
                </div>

                <div class="form-group">
                    <label>ä»¶æ•°</label>
                    <input type="number" id="quantity" value="1" min="1" step="1">
                </div>

                <div class="form-group">
                    <label>å•ä»¶æˆæœ¬ä»· (Â¥)</label>
                    <input type="number" id="costPrice" placeholder="0.00" step="0.01" min="0">
                </div>

                <div class="form-group">
                    <label>å‡ºå”®æ—¥æœŸ <span style="color: #999; font-weight: normal;">(å¯é€‰)</span></label>
                    <input type="date" id="sellDate">
                </div>

                <div class="form-group">
                    <label>å•ä»¶å”®å‡ºä»· <span style="color: #999; font-weight: normal;">(å¯é€‰)</span></label>
                    <input type="number" id="sellPrice" placeholder="å¾…å¡«å†™" step="0.01" min="0">
                </div>

                <div class="form-group">
                    <label>å¤‡æ³¨</label>
                    <input type="text" id="remark" placeholder="å…¶ä»–è¯´æ˜">
                </div>

                <button class="btn btn-primary" onclick="addRecord()">æ·»åŠ è®°å½•</button>
            </div>

            <!-- æ•°æ®ç»Ÿè®¡ + ç¼–è¾‘æ¨¡æ€æ¡† -->
            <div class="card">
                <h2>ğŸ“ˆ æ•°æ®ç»Ÿè®¡</h2>

                <!-- ç¼–è¾‘è®°å½•æ¨¡æ€æ¡† -->
                <div class="modal" id="editModal">
                    <div class="modal-content">
                        <button class="modal-close" onclick="closeEditModal()">Ã—</button>
                        <div class="modal-header">ç¼–è¾‘è®°å½•</div>
                        
                        <div class="modal-body">
                            <div class="form-group form-group-modal">
                                <label>è´­ä¹°æ—¥æœŸ</label>
                                <input type="date" id="editBuyDate">
                            </div>
                            <div class="form-group form-group-modal">
                                <label>è´­ä¹°å¹³å°</label>
                                <select id="editBuyPlatform">
                                    <option value="æ·˜å®">æ·˜å®</option>
                                    <option value="äº¬ä¸œ">äº¬ä¸œ</option>
                                    <option value="æ‹¼å¤šå¤š">æ‹¼å¤šå¤š</option>
                                    <option value="å¾—ç‰©">å¾—ç‰©</option>
                                    <option value="æŠ–éŸ³å°åº—">æŠ–éŸ³å°åº—</option>
                                    <option value="å°çº¢ä¹¦">å°çº¢ä¹¦</option>
                                    <option value="äºšé©¬é€Š">äºšé©¬é€Š</option>
                                    <option value="eBay">eBay</option>
                                    <option value="å…¶ä»–">å…¶ä»–</option>
                                </select>
                            </div>
                            <div class="form-group form-group-modal">
                                <label>è´§å·</label>
                                <input type="text" id="editGoodsCode">
                            </div>
                            <div class="form-group form-group-modal">
                                <label>å•†å“æè¿°</label>
                                <input type="text" id="editGoodsDesc">
                            </div>
                            <div class="form-group form-group-modal">
                                <label>ä»¶æ•°</label>
                                <input type="number" id="editQuantity" min="1" step="1">
                            </div>
                            <div class="form-group form-group-modal">
                                <label>å•ä»¶æˆæœ¬ä»· (Â¥)</label>
                                <input type="number" id="editCostPrice" step="0.01" min="0">
                            </div>
                            <div class="form-group form-group-modal">
                                <label>å‡ºå”®æ—¥æœŸ</label>
                                <input type="date" id="editSellDate">
                            </div>
                            <div class="form-group form-group-modal">
                                <label>å•ä»¶å”®å‡ºä»· (Â¥)</label>
                                <input type="number" id="editSellPrice" step="0.01" min="0">
                            </div>
                            <div class="form-group form-group-modal">
                                <label>å¤‡æ³¨</label>
                                <input type="text" id="editRemark">
                            </div>
                        </div>
                        
                        <div class="modal-actions">
                            <button class="btn btn-secondary" onclick="closeEditModal()">å–æ¶ˆ</button>
                            <button class="btn btn-primary" onclick="saveRecord()">ä¿å­˜ä¿®æ”¹</button>
                        </div>
                    </div>
                </div>

                <!-- ç»Ÿè®¡æ•°å­— -->
                <div style="padding: 20px 0;">
                    <div style="margin-bottom: 20px;">
                        <div style="font-size: 12px; color: #666; margin-bottom: 5px;">æ€»äº¤æ˜“ç¬”æ•°</div>
                        <div style="font-size: 28px; font-weight: 700; color: #667eea;" id="totalCount">0</div>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <div style="font-size: 12px; color: #666; margin-bottom: 5px;">æ€»ä»¶æ•°</div>
                        <div style="font-size: 28px; font-weight: 700; color: #667eea;" id="totalQuantity">0</div>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <div style="font-size: 12px; color: #666; margin-bottom: 5px;">æ€»æˆæœ¬</div>
                        <div style="font-size: 28px; font-weight: 700; color: #333;" id="totalCost">Â¥0.00</div>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <div style="font-size: 12px; color: #666; margin-bottom: 5px;">æ€»æ”¶ç›Š</div>
                        <div style="font-size: 28px; font-weight: 700; color: #22c55e;" id="totalRevenue">Â¥0.00</div>
                    </div>
                    <div>
                        <div style="font-size: 12px; color: #666; margin-bottom: 5px;">æ€»åˆ©æ¶¦ / å¹³å‡åˆ©æ¶¦ç‡</div>
                        <div style="font-size: 20px; font-weight: 700; color: #764ba2;">
                            <span id="totalProfit">Â¥0.00</span>
                            <span style="margin-left: 8px;" id="avgProfitRate">0%</span>
                        </div>
                    </div>
                </div>
                
                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="exportData()">ğŸ“¥ å¯¼å‡ºæ•°æ®</button>
                    <button class="btn btn-secondary" onclick="clearAllData()">ğŸ—‘ï¸ æ¸…ç©ºæ•°æ®</button>
                </div>
            </div>

            <!-- è®°å½•åˆ—è¡¨ -->
            <div class="card records-section">
                <h2>ğŸ“‹ äº¤æ˜“è®°å½•</h2>
                <div class="table-scroll">
                    <table id="recordsTable">
                        <thead>
                            <tr>
                                <th>åºå·</th>
                                <th>è´­ä¹°æ—¥æœŸ</th>
                                <th>å¹³å°</th>
                                <th>è´§å·</th>
                                <th>å•†å“æè¿°</th>
                                <th>ä»¶æ•°</th>
                                <th>å•ä»¶æˆæœ¬</th>
                                <th>æ€»æˆæœ¬</th>
                                <th>å‡ºå”®æ—¥æœŸ</th>
                                <th>å•ä»¶å”®å‡ºä»·</th>
                                <th>æ€»å”®å‡ºä»·</th>
                                <th>åˆ©æ¶¦</th>
                                <th>åˆ©æ¶¦ç‡</th>
                                <th style="width: 120px;">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            <tr class="empty-state">
                                <td colspan="14">æš‚æ— æ•°æ®ï¼Œæ·»åŠ ç¬¬ä¸€æ¡è®°å½•å§ ğŸ‘†</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // æ•°æ®è§„èŒƒåŒ–ï¼šå…¼å®¹æ—§ç‰ˆæœ¬ç»“æ„ï¼Œä¿è¯ quantity ç­‰å­—æ®µå­˜åœ¨
        function normalizeRecords(rawRecords) {
            if (!Array.isArray(rawRecords)) return [];

            return rawRecords.map(r => {
                const record = { ...r };

                // æ—§è®°å½•å¯èƒ½æ²¡æœ‰ quantityï¼Œé»˜è®¤ 1
                if (!record.quantity || record.quantity <= 0) {
                    record.quantity = 1;
                }

                // ç¡®ä¿è¿™äº›å­—æ®µå­˜åœ¨
                if (record.costPrice === undefined || record.costPrice === null || record.costPrice === '') {
                    record.costPrice = '0.00';
                }
                if (record.sellPrice === undefined || record.sellPrice === null) {
                    record.sellPrice = '';
                }
                if (!record.goodsCode) record.goodsCode = '';
                if (!record.goodsDesc) record.goodsDesc = '';
                if (!record.buyPlatform) record.buyPlatform = '';
                if (!record.buyDate) record.buyDate = '';
                if (!record.sellDate) record.sellDate = '';
                if (!record.remark) record.remark = '';

                // æ—§æ•°æ®ä¸­ profitRate å¯èƒ½å¸¦ %ï¼Œç»Ÿä¸€å»æ‰
                if (typeof record.profitRate === 'string' && record.profitRate.endsWith('%')) {
                    record.profitRate = record.profitRate.replace('%', '');
                }

                const cost = parseFloat(record.costPrice) || 0;
                const sell = record.sellPrice === '' ? NaN : parseFloat(record.sellPrice);

                // å¦‚æœæ²¡æœ‰ profitï¼Œä½†æœ‰ä»·æ ¼ä¿¡æ¯ï¼Œåˆ™æŒ‰å½“å‰è§„åˆ™è®¡ç®—
                if ((record.profit === undefined || record.profit === null || record.profit === '') && !isNaN(sell)) {
                    const totalCost = cost * record.quantity;
                    const totalSell = sell * record.quantity;
                    const p = totalSell - totalCost;
                    record.profit = p.toFixed(2);
                    record.profitRate = totalCost > 0 ? ((p / totalCost) * 100).toFixed(2) : '';
                }

                return record;
            });
        }

        // åˆå§‹åŒ–æ—¥æœŸä¸ºä»Šå¤©
        document.getElementById('buyDate').valueAsDate = new Date();
        document.getElementById('sellDate').valueAsDate = new Date();

        // ä»æœ¬åœ°å­˜å‚¨åŠ è½½å¹¶è§„èŒƒåŒ–æ•°æ®
        let records = normalizeRecords(JSON.parse(localStorage.getItem('purchaseRecords')) || []);
        let editingRecordId = null;

        function openEditModal(id) {
            editingRecordId = id;
            const record = records.find(r => r.id === id);
            
            if (record) {
                document.getElementById('editBuyDate').value = record.buyDate;
                document.getElementById('editBuyPlatform').value = record.buyPlatform;
                document.getElementById('editGoodsCode').value = record.goodsCode;
                document.getElementById('editGoodsDesc').value = record.goodsDesc;
                document.getElementById('editQuantity').value = record.quantity;
                document.getElementById('editCostPrice').value = record.costPrice;
                document.getElementById('editSellDate').value = record.sellDate;
                document.getElementById('editSellPrice').value = record.sellPrice;
                document.getElementById('editRemark').value = record.remark;
                
                document.getElementById('editModal').classList.add('active');
            }
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.remove('active');
            editingRecordId = null;
        }

        function saveRecord() {
            if (editingRecordId === null) return;
            
            const quantity = parseInt(document.getElementById('editQuantity').value, 10) || 0;
            const costPrice = parseFloat(document.getElementById('editCostPrice').value) || 0;
            const sellPrice = document.getElementById('editSellPrice').value;

            if (!quantity || !costPrice) {
                alert('è¯·å¡«å†™ä»¶æ•°å’Œæˆæœ¬ä»·');
                return;
            }

            let profit = '';
            let profitRate = '';

            if (sellPrice !== '') {
                const sellPriceNum = parseFloat(sellPrice);
                const totalCost = costPrice * quantity;
                const totalSell = sellPriceNum * quantity;
                profit = (totalSell - totalCost).toFixed(2);
                profitRate = totalCost > 0 ? ((profit / totalCost) * 100).toFixed(2) : 0;
            }

            const recordIndex = records.findIndex(r => r.id === editingRecordId);
            if (recordIndex !== -1) {
                records[recordIndex] = {
                    ...records[recordIndex],
                    buyDate: document.getElementById('editBuyDate').value,
                    buyPlatform: document.getElementById('editBuyPlatform').value,
                    goodsCode: document.getElementById('editGoodsCode').value,
                    goodsDesc: document.getElementById('editGoodsDesc').value,
                    quantity,
                    costPrice: costPrice.toFixed(2),
                    sellDate: document.getElementById('editSellDate').value,
                    sellPrice: sellPrice === '' ? '' : parseFloat(sellPrice).toFixed(2),
                    profit: profit,
                    profitRate: profitRate,
                    remark: document.getElementById('editRemark').value
                };

                saveData();
                renderTable();
                closeEditModal();

                const msg = document.getElementById('successMsg');
                msg.textContent = 'âœ“ è®°å½•å·²æ›´æ–°';
                msg.classList.add('show');
                setTimeout(() => msg.classList.remove('show'), 2000);
            }
        }

        function editRecord(id) {
            openEditModal(id);
        }

        function addRecord() {
            const buyDate = document.getElementById('buyDate').value;
            const buyPlatform = document.getElementById('buyPlatform').value;
            const goodsCode = document.getElementById('goodsCode').value;
            const goodsDesc = document.getElementById('goodsDesc').value;
            const quantity = parseInt(document.getElementById('quantity').value, 10) || 0;
            const costPrice = parseFloat(document.getElementById('costPrice').value) || 0;
            const sellDate = document.getElementById('sellDate').value;
            const sellPrice = document.getElementById('sellPrice').value;
            const remark = document.getElementById('remark').value;

            if (!buyDate || !buyPlatform || !quantity || !costPrice) {
                alert('è¯·å¡«å†™å¿…è¦ä¿¡æ¯ï¼šè´­ä¹°æ—¥æœŸã€å¹³å°ã€ä»¶æ•°ã€æˆæœ¬ä»·\nå”®å‡ºä»·å¯ç¨åæ·»åŠ ');
                return;
            }

            let profit = '';
            let profitRate = '';

            if (sellPrice !== '') {
                const sellPriceNum = parseFloat(sellPrice);
                const totalCost = costPrice * quantity;
                const totalSell = sellPriceNum * quantity;
                profit = (totalSell - totalCost).toFixed(2);
                profitRate = totalCost > 0 ? ((profit / totalCost) * 100).toFixed(2) : 0;
            }

            const record = {
                id: Date.now(),
                buyDate,
                buyPlatform,
                goodsCode,
                goodsDesc,
                quantity,
                costPrice: costPrice.toFixed(2),
                sellDate,
                sellPrice: sellPrice === '' ? '' : parseFloat(sellPrice).toFixed(2),
                profit: profit,
                profitRate: profitRate,
                remark
            };

            records.push(record);
            saveData();
            renderTable();

            // æ¸…ç©ºè¡¨å•
            document.getElementById('buyDate').valueAsDate = new Date();
            document.getElementById('buyPlatform').value = '';
            document.getElementById('goodsCode').value = '';
            document.getElementById('goodsDesc').value = '';
            document.getElementById('quantity').value = 1;
            document.getElementById('costPrice').value = '';
            document.getElementById('sellDate').valueAsDate = new Date();
            document.getElementById('sellPrice').value = '';
            document.getElementById('remark').value = '';

            // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
            const msg = document.getElementById('successMsg');
            msg.textContent = 'âœ“ è®°å½•å·²æ·»åŠ ';
            msg.classList.add('show');
            setTimeout(() => msg.classList.remove('show'), 2000);
        }

        function deleteRecord(id) {
            if (confirm('ç¡®è®¤åˆ é™¤æ­¤è®°å½•ï¼Ÿ')) {
                records = records.filter(r => r.id !== id);
                saveData();
                renderTable();
            }
        }

        function renderTable() {
            const tbody = document.getElementById('tableBody');
            
            if (records.length === 0) {
                tbody.innerHTML = '<tr class="empty-state"><td colspan="14">æš‚æ— æ•°æ®ï¼Œæ·»åŠ ç¬¬ä¸€æ¡è®°å½•å§ ğŸ‘†</td></tr>';
                updateStats();
                return;
            }

            tbody.innerHTML = records.map((record, index) => {
                const profitClass = record.profit === '' ? '' : (record.profit >= 0 ? 'profit-positive' : 'profit-negative');
                const profitDisplay = record.profit === '' ? 'å¾…å®š' : `Â¥${record.profit}`;
                const rateText = record.profitRate === '' || record.profitRate === undefined || record.profitRate === null
                    ? 'å¾…å®š'
                    : `${record.profitRate}%`;
                const sellDateDisplay = record.sellDate === '' ? '-' : record.sellDate;
                const sellPriceDisplay = record.sellPrice === '' ? '-' : `Â¥${parseFloat(record.sellPrice).toFixed(2)}`;
                const totalCost = (parseFloat(record.costPrice) * (record.quantity || 0)).toFixed(2);
                const totalSell = record.sellPrice === '' ? '-' : `Â¥${(parseFloat(record.sellPrice) * (record.quantity || 0)).toFixed(2)}`;

                return `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${record.buyDate}</td>
                        <td>${record.buyPlatform}</td>
                        <td>${record.goodsCode}</td>
                        <td>${record.goodsDesc}</td>
                        <td>${record.quantity}</td>
                        <td>Â¥${parseFloat(record.costPrice).toFixed(2)}</td>
                        <td>Â¥${totalCost}</td>
                        <td>${sellDateDisplay}</td>
                        <td>${sellPriceDisplay}</td>
                        <td>${totalSell}</td>
                        <td class="${profitClass}">${profitDisplay}</td>
                        <td class="${profitClass}">${rateText}</td>
                        <td style="display: flex; gap: 5px;">
                            <button class="btn btn-danger" style="flex: 1; padding: 6px 8px; font-size: 11px;" onclick="editRecord(${record.id})">ç¼–è¾‘</button>
                            <button class="btn btn-danger" style="flex: 1; padding: 6px 8px; font-size: 11px; background: #ff6b6b;" onclick="deleteRecord(${record.id})">åˆ é™¤</button>
                        </td>
                    </tr>
                `;
            }).join('');

            updateStats();
        }

        function updateStats() {
            const totalCount = records.length;
            const totalQuantity = records.reduce((sum, r) => sum + (r.quantity || 0), 0);
            const totalCost = records.reduce((sum, r) => sum + (parseFloat(r.costPrice) * (r.quantity || 0)), 0);
            const totalRevenue = records.reduce((sum, r) => {
                if (r.sellPrice === '') return sum;
                return sum + (parseFloat(r.sellPrice) * (r.quantity || 0));
            }, 0);
            const totalProfit = totalRevenue - totalCost;
            const avgProfitRate = totalCost > 0 ? ((totalProfit / totalCost) * 100).toFixed(2) : 0;

            document.getElementById('totalCount').textContent = totalCount;
            document.getElementById('totalQuantity').textContent = totalQuantity;
            document.getElementById('totalCost').textContent = 'Â¥' + totalCost.toFixed(2);
            document.getElementById('totalRevenue').textContent = 'Â¥' + totalRevenue.toFixed(2);
            document.getElementById('totalProfit').textContent = 'Â¥' + totalProfit.toFixed(2);
            document.getElementById('avgProfitRate').textContent = avgProfitRate + '%';
        }

        function saveData() {
            localStorage.setItem('purchaseRecords', JSON.stringify(records));
        }

        function exportData() {
            if (records.length === 0) {
                alert('æš‚æ— æ•°æ®å¯å¯¼å‡º');
                return;
            }

            let csv = 'åºå·,è´­ä¹°æ—¥æœŸ,è´­ä¹°å¹³å°,è´§å·,å•†å“æè¿°,ä»¶æ•°,å•ä»¶æˆæœ¬,æ€»æˆæœ¬,å‡ºå”®æ—¥æœŸ,å•ä»¶å”®å‡ºä»·,æ€»å”®å‡ºä»·,åˆ©æ¶¦,åˆ©æ¶¦ç‡,å¤‡æ³¨\n';
            
            records.forEach((record, index) => {
                const totalCost = (parseFloat(record.costPrice) * (record.quantity || 0)).toFixed(2);
                const totalSell = record.sellPrice === '' ? '' : (parseFloat(record.sellPrice) * (record.quantity || 0)).toFixed(2);
                const rate = record.profitRate === '' || record.profitRate === undefined || record.profitRate === null
                    ? ''
                    : record.profitRate;
                csv += `${index + 1},"${record.buyDate}","${record.buyPlatform}","${record.goodsCode}","${record.goodsDesc}",${record.quantity},${record.costPrice},${totalCost},"${record.sellDate}",${record.sellPrice},${totalSell},${record.profit},${rate}%,"${record.remark}"\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `è´­é”€è®°è´¦_${new Date().toISOString().split('T')[0]}.csv`);
            link.click();
        }

        function clearAllData() {
            if (confirm('ç¡®è®¤æ¸…ç©ºæ‰€æœ‰æ•°æ®ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼')) {
                records = [];
                saveData();
                renderTable();
                alert('æ•°æ®å·²æ¸…ç©º');
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ¸²æŸ“è¡¨æ ¼
        renderTable();
    </script>
</body>
</html>
